"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.MessageSerializer = exports.MessageParser = void 0;
const packet_1 = __importDefault(require("./packet"));
const runtime_1 = require("../../../errors/runtime");
const types_1 = require("../../../errors/types");
const create_replicator_1 = __importDefault(require("../../serialization/replicator/create-replicator"));
const replicator = create_replicator_1.default();
class MessageParser {
    constructor() {
        this.dataQueue = [];
        this.packetQueue = [];
    }
    static _concatPackets(packets) {
        const data = packets.map(packet => packet.data);
        return Buffer.concat(data);
    }
    _processPacket(packet) {
        if (packet.header.tail) {
            if (!packet.header.head && this.packetQueue.length === 0)
                throw new runtime_1.GeneralError(types_1.RUNTIME_ERRORS.unexpectedIPCTailPacket);
            const packets = this.packetQueue.splice(0, this.packetQueue.length);
            const data = packet.header.head ? packet.data : MessageParser._concatPackets([...packets, packet]);
            return replicator.decode(data.toString());
        }
        if (packet.header.head && this.packetQueue.length !== 0) {
            this.packetQueue.splice(0, this.packetQueue.length);
            throw new runtime_1.GeneralError(types_1.RUNTIME_ERRORS.unexpectedIPCHeadPacket);
        }
        if (!packet.header.head && !packet.header.tail && this.packetQueue.length === 0)
            throw new runtime_1.GeneralError(types_1.RUNTIME_ERRORS.unexpectedIPCBodyPacket);
        this.packetQueue.push(packet);
        return void 0;
    }
    _processData() {
        let buffer = Buffer.concat(this.dataQueue.splice(0, this.dataQueue.length));
        let packet = packet_1.default.parse(buffer);
        const messages = [];
        while (packet) {
            const message = this._processPacket(packet);
            if (message)
                messages.push(message);
            buffer = buffer.slice(packet.header.totalSize);
            packet = packet_1.default.parse(buffer);
        }
        if (buffer.length)
            this.dataQueue.unshift(buffer);
        return messages;
    }
    parse(data) {
        this.dataQueue.push(data);
        return this._processData();
    }
}
exports.MessageParser = MessageParser;
class MessageSerializer {
    static _chunkData(data) {
        const chunks = [];
        for (let index = 0; index < data.length; index += packet_1.default.MAX_PAYLOAD_SIZE) {
            const size = Math.min(data.length - index, packet_1.default.MAX_PAYLOAD_SIZE);
            const head = index === 0;
            const tail = index + size >= data.length;
            chunks.push(packet_1.default.serialize(data.slice(index, index + size), { head, tail }));
        }
        return chunks;
    }
    serialize(message) {
        const encodedMessage = replicator.encode(message);
        return MessageSerializer._chunkData(Buffer.from(encodedMessage));
    }
}
exports.MessageSerializer = MessageSerializer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVzc2FnZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9zZXJ2aWNlcy91dGlscy9pcGMvbWVzc2FnZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxzREFBMkQ7QUFDM0QscURBQXVEO0FBQ3ZELGlEQUF1RDtBQUN2RCx5R0FBZ0Y7QUFFaEYsTUFBTSxVQUFVLEdBQUcsMkJBQWdCLEVBQUUsQ0FBQztBQUV0QyxNQUFhLGFBQWE7SUFJdEI7UUFDSSxJQUFJLENBQUMsU0FBUyxHQUFLLEVBQUUsQ0FBQztRQUN0QixJQUFJLENBQUMsV0FBVyxHQUFHLEVBQUUsQ0FBQztJQUMxQixDQUFDO0lBRU8sTUFBTSxDQUFDLGNBQWMsQ0FBRSxPQUF1QjtRQUNsRCxNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRWhELE9BQU8sTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUMvQixDQUFDO0lBRU8sY0FBYyxDQUFFLE1BQW9CO1FBQ3hDLElBQUksTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUU7WUFDcEIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxLQUFLLENBQUM7Z0JBQ3BELE1BQU0sSUFBSSxzQkFBWSxDQUFDLHNCQUFjLENBQUMsdUJBQXVCLENBQUMsQ0FBQztZQUVuRSxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUNwRSxNQUFNLElBQUksR0FBTSxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFD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QUUsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO1NBQ2xGO1FBRUQsT0FBTyxNQUFNLENBQUM7SUFDbEIsQ0FBQztJQUVNLFNBQVMsQ0FBRSxPQUFlO1FBQzdCLE1BQU0sY0FBYyxHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFbEQsT0FBTyxpQkFBaUIsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDO0lBQ3JFLENBQUM7Q0FDSjtBQXBCRCw4Q0FvQkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBkZWZhdWx0IGFzIFBhY2tldCwgUGFyc2VkUGFja2V0IH0gZnJvbSAnLi9wYWNrZXQnO1xuaW1wb3J0IHsgR2VuZXJhbEVycm9yIH0gZnJvbSAnLi4vLi4vLi4vZXJyb3JzL3J1bnRpbWUnO1xuaW1wb3J0IHsgUlVOVElNRV9FUlJPUlMgfSBmcm9tICcuLi8uLi8uLi9lcnJvcnMvdHlwZXMnO1xuaW1wb3J0IGNyZWF0ZVJlcGxpY2F0b3IgZnJvbSAnLi4vLi4vc2VyaWFsaXphdGlvbi9yZXBsaWNhdG9yL2NyZWF0ZS1yZXBsaWNhdG9yJztcblxuY29uc3QgcmVwbGljYXRvciA9IGNyZWF0ZVJlcGxpY2F0b3IoKTtcblxuZXhwb3J0IGNsYXNzIE1lc3NhZ2VQYXJzZXIge1xuICAgIHByaXZhdGUgcmVhZG9ubHkgZGF0YVF1ZXVlOiBCdWZmZXJbXTtcbiAgICBwcml2YXRlIHJlYWRvbmx5IHBhY2tldFF1ZXVlOiBQYXJzZWRQYWNrZXRbXTtcblxuICAgIHB1YmxpYyBjb25zdHJ1Y3RvciAoKSB7XG4gICAgICAgIHRoaXMuZGF0YVF1ZXVlICAgPSBbXTtcbiAgICAgICAgdGhpcy5wYWNrZXRRdWV1ZSA9IFtdO1xuICAgIH1cblxuICAgIHByaXZhdGUgc3RhdGljIF9jb25jYXRQYWNrZXRzIChwYWNrZXRzOiBQYXJzZWRQYWNrZXRbXSk6IEJ1ZmZlciB7XG4gICAgICAgIGNvbnN0IGRhdGEgPSBwYWNrZXRzLm1hcChwYWNrZXQgPT4gcGFja2V0LmRhdGEpO1xuXG4gICAgICAgIHJldHVybiBCdWZmZXIuY29uY2F0KGRhdGEpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX3Byb2Nlc3NQYWNrZXQgKHBhY2tldDogUGFyc2VkUGFja2V0KTogb2JqZWN0fHVuZGVmaW5lZCB7XG4gICAgICAgIGlmIChwYWNrZXQuaGVhZGVyLnRhaWwpIHtcbiAgICAgICAgICAgIGlmICghcGFja2V0LmhlYWRlci5oZWFkICYmIHRoaXMucGFja2V0UXVldWUubGVuZ3RoID09PSAwKVxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBHZW5lcmFsRXJyb3IoUlVOVElNRV9FUlJPUlMudW5leHBlY3RlZElQQ1RhaWxQYWNrZXQpO1xuXG4gICAgICAgICAgICBjb25zdCBwYWNrZXRzID0gdGhpcy5wYWNrZXRRdWV1ZS5zcGxpY2UoMCwgdGhpcy5wYWNrZXRRdWV1ZS5sZW5ndGgpO1xuICAgICAgICAgICAgY29uc3QgZGF0YSAgICA9IHBhY2tldC5oZWFkZXIuaGVhZCA/IHBhY2tldC5kYXRhIDogTWVzc2FnZVBhcnNlci5fY29uY2F0UGFja2V0cyhbLi4ucGFja2V0cywgcGFja2V0XSk7XG5cbiAgICAgICAgICAgIHJldHVybiByZXBsaWNhdG9yLmRlY29kZShkYXRhLnRvU3RyaW5nKCkpIGFzIG9iamVjdDtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChwYWNrZXQuaGVhZGVyLmhlYWQgJiYgdGhpcy5wYWNrZXRRdWV1ZS5sZW5ndGggIT09IDApIHtcbiAgICAgICAgICAgIHRoaXMucGFja2V0UXVldWUuc3BsaWNlKDAsIHRoaXMucGFja2V0UXVldWUubGVuZ3RoKTtcblxuICAgICAgICAgICAgdGhyb3cgbmV3IEdlbmVyYWxFcnJvcihSVU5USU1FX0VSUk9SUy51bmV4cGVjdGVkSVBDSGVhZFBhY2tldCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXBhY2tldC5oZWFkZXIuaGVhZCAmJiAhcGFja2V0LmhlYWRlci50YWlsICYmIHRoaXMucGFja2V0UXVldWUubGVuZ3RoID09PSAwKVxuICAgICAgICAgICAgdGhyb3cgbmV3IEdlbmVyYWxFcnJvcihSVU5USU1FX0VSUk9SUy51bmV4cGVjdGVkSVBDQm9keVBhY2tldCk7XG5cbiAgICAgICAgdGhpcy5wYWNrZXRRdWV1ZS5wdXNoKHBhY2tldCk7XG5cbiAgICAgICAgcmV0dXJuIHZvaWQgMDtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9wcm9jZXNzRGF0YSAoKTogb2JqZWN0W10ge1xuICAgICAgICBsZXQgYnVmZmVyID0gQnVmZmVyLmNvbmNhdCh0aGlzLmRhdGFRdWV1ZS5zcGxpY2UoMCwgdGhpcy5kYXRhUXVldWUubGVuZ3RoKSk7XG4gICAgICAgIGxldCBwYWNrZXQgPSBQYWNrZXQucGFyc2UoYnVmZmVyKTtcblxuICAgICAgICBjb25zdCBtZXNzYWdlcyA9IFtdO1xuXG4gICAgICAgIHdoaWxlIChwYWNrZXQpIHtcbiAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSB0aGlzLl9wcm9jZXNzUGFja2V0KHBhY2tldCk7XG5cbiAgICAgICAgICAgIGlmIChtZXNzYWdlKVxuICAgICAgICAgICAgICAgIG1lc3NhZ2VzLnB1c2gobWVzc2FnZSk7XG5cbiAgICAgICAgICAgIGJ1ZmZlciA9IGJ1ZmZlci5zbGljZShwYWNrZXQuaGVhZGVyLnRvdGFsU2l6ZSk7XG5cbiAgICAgICAgICAgIHBhY2tldCA9IFBhY2tldC5wYXJzZShidWZmZXIpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGJ1ZmZlci5sZW5ndGgpXG4gICAgICAgICAgICB0aGlzLmRhdGFRdWV1ZS51bnNoaWZ0KGJ1ZmZlcik7XG5cbiAgICAgICAgcmV0dXJuIG1lc3NhZ2VzO1xuICAgIH1cblxuICAgIHB1YmxpYyBwYXJzZSAoZGF0YTogQnVmZmVyKTogb2JqZWN0W10ge1xuICAgICAgICB0aGlzLmRhdGFRdWV1ZS5wdXNoKGRhdGEpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLl9wcm9jZXNzRGF0YSgpO1xuICAgIH1cbn1cblxuZXhwb3J0IGNsYXNzIE1lc3NhZ2VTZXJpYWxpemVyIHtcbiAgICBwcml2YXRlIHN0YXRpYyBfY2h1bmtEYXRhIChkYXRhOiBCdWZmZXIpOiBCdWZmZXJbXSB7XG4gICAgICAgIGNvbnN0IGNodW5rcyA9IFtdO1xuXG4gICAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBkYXRhLmxlbmd0aDsgaW5kZXggKz0gUGFja2V0Lk1BWF9QQVlMT0FEX1NJWkUpIHtcbiAgICAgICAgICAgIGNvbnN0IHNpemUgPSBNYXRoLm1pbihkYXRhLmxlbmd0aCAtIGluZGV4LCBQYWNrZXQuTUFYX1BBWUxPQURfU0laRSk7XG4gICAgICAgICAgICBjb25zdCBoZWFkID0gaW5kZXggPT09IDA7XG4gICAgICAgICAgICBjb25zdCB0YWlsID0gaW5kZXggKyBzaXplID49IGRhdGEubGVuZ3RoO1xuXG4gICAgICAgICAgICBjaHVua3MucHVzaChQYWNrZXQuc2VyaWFsaXplKGRhdGEuc2xpY2UoaW5kZXgsIGluZGV4ICsgc2l6ZSksIHsgaGVhZCwgdGFpbCB9KSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gY2h1bmtzO1xuICAgIH1cblxuICAgIHB1YmxpYyBzZXJpYWxpemUgKG1lc3NhZ2U6IG9iamVjdCk6IEJ1ZmZlcltdIHtcbiAgICAgICAgY29uc3QgZW5jb2RlZE1lc3NhZ2UgPSByZXBsaWNhdG9yLmVuY29kZShtZXNzYWdlKTtcblxuICAgICAgICByZXR1cm4gTWVzc2FnZVNlcmlhbGl6ZXIuX2NodW5rRGF0YShCdWZmZXIuZnJvbShlbmNvZGVkTWVzc2FnZSkpO1xuICAgIH1cbn1cbiJdfQ==