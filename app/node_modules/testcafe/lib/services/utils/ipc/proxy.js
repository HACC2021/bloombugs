"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.IPCProxy = void 0;
const async_event_emitter_1 = __importDefault(require("../../../utils/async-event-emitter"));
const lodash_1 = require("lodash");
const interfaces_1 = require("./interfaces");
class IPCProxy extends async_event_emitter_1.default {
    constructor(transport) {
        super();
        this._requestCounter = 0;
        this._transport = transport;
        this._handlers = {};
        this._transport.read();
        this._transport.on(interfaces_1.IPCTransportEvents.data, rawPacket => this._onRead(rawPacket));
        this.on('request', data => this._onRequest(data));
    }
    async _onRead(packet) {
        if (packet.type === interfaces_1.IPCPacketType.response)
            this.emit(`response-${packet.id}`, packet);
        else
            this.emit('request', packet);
    }
    async _onRequest(requestPacket) {
        let resultData = null;
        try {
            resultData = { result: await this._handlers[requestPacket.data.name](...requestPacket.data.args) };
        }
        catch (error) {
            resultData = { error };
        }
        const responsePacket = {
            id: requestPacket.id,
            type: interfaces_1.IPCPacketType.response,
            sync: requestPacket.sync,
            data: resultData,
        };
        await this._transport.write(responsePacket);
    }
    _createPacket(opts) {
        return {
            id: this._requestCounter++,
            type: interfaces_1.IPCPacketType.request,
            sync: opts.sync,
            data: opts.data,
        };
    }
    _createPlainError(errorData) {
        const error = new Error(errorData.message);
        Object.assign(error, errorData);
        return error;
    }
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    register(func, context = null) {
        func = lodash_1.castArray(func);
        func.forEach(fn => {
            if (this._handlers[fn.name])
                return;
            this._handlers[fn.name] = fn.bind(context);
        });
    }
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    async call(target, ...args) {
        const name = typeof target === 'string' ? target : target.name;
        const packet = this._createPacket({ data: { name, args }, sync: false });
        const responsePromise = this.once(`response-${packet.id}`);
        await this._transport.write(packet);
        const { data } = await responsePromise;
        if (interfaces_1.isIPCErrorResponse(data))
            throw data.error;
        return data.result;
    }
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    callSync(target, ...args) {
        const name = typeof target === 'string' ? target : target.name;
        const requestPacket = this._createPacket({ data: { name, args }, sync: true });
        this._transport.writeSync(requestPacket);
        let responsePacket = this._transport.readSync();
        while (responsePacket.id !== requestPacket.id)
            responsePacket = this._transport.readSync();
        const response = responsePacket.data;
        if (interfaces_1.isIPCErrorResponse(response))
            throw response.error;
        return response.result;
    }
}
exports.IPCProxy = IPCProxy;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJveHkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvc2VydmljZXMvdXRpbHMvaXBjL3Byb3h5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLDZGQUE4RDtBQUM5RCxtQ0FBbUM7QUFFbkMsNkNBU3NCO0FBUXRCLE1BQWEsUUFBUyxTQUFRLDZCQUFZO0lBS3RDLFlBQW9CLFNBQXVCO1FBQ3ZDLEtBQUssRUFBRSxDQUFDO1FBSkosb0JBQWUsR0FBVyxDQUFDLENBQUM7UUFNaEMsSUFBSSxDQUFDLFVBQVUsR0FBRyxTQUFTLENBQUM7UUFFNUIsSUFBSSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUM7UUFFcEIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUN2QixJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQywrQkFBa0IsQ0FBQyxJQUFJLEVBQUUsU0FBUyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7UUFDbEYsSUFBSSxDQUFDLEVBQUUsQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDdEQsQ0FBQztJQUVPLEtBQUssQ0FBQyxPQUFPLENBQUUsTUFBaUI7UUFDcEMsSUFBSSxNQUFNLENBQUMsSUFBSSxLQUFLLDBCQUFhLENBQUMsUUFBUTtZQUN0QyxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksTUFBTSxDQUFDLEVBQUUsRUFBRSxFQUFFLE1BQU0sQ0FBQyxDQUFDOztZQUUzQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUNyQyxDQUFDO0lBRU8sS0FBSyxDQUFDLFVBQVUsQ0FBRSxhQUErQjtRQUNyRCxJQUFJLFVBQVUsR0FBRyxJQUFJLENBQUM7UUFFdEIsSUFBSTtZQUNBLFVBQVUsR0FB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LEVBQUUsSUFBSSxFQUFFLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBRS9FLElBQUksQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBRXpDLElBQUksY0FBYyxHQUFzQixJQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBRW5FLE9BQU8sY0FBYyxDQUFDLEVBQUUsS0FBSyxhQUFhLENBQUMsRUFBRTtZQUN6QyxjQUFjLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUVoRCxNQUFNLFFBQVEsR0FBRyxjQUFjLENBQUMsSUFBSSxDQUFDO1FBRXJDLElBQUksK0JBQWtCLENBQUMsUUFBUSxDQUFDO1lBQzVCLE1BQU0sUUFBUSxDQUFDLEtBQUssQ0FBQztRQUV6QixPQUFPLFFBQVEsQ0FBQyxNQUFNLENBQUM7SUFDM0IsQ0FBQztDQUNKO0FBN0dELDRCQTZHQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBFdmVudEVtaXR0ZXIgZnJvbSAnLi4vLi4vLi4vdXRpbHMvYXN5bmMtZXZlbnQtZW1pdHRlcic7XG5pbXBvcnQgeyBjYXN0QXJyYXkgfSBmcm9tICdsb2Rhc2gnO1xuXG5pbXBvcnQge1xuICAgIElQQ1BhY2tldCxcbiAgICBJUENQYWNrZXRUeXBlLFxuICAgIElQQ1JlcXVlc3RQYWNrZXQsXG4gICAgSVBDUmVzcG9uc2VQYWNrZXQsXG4gICAgSVBDUmVxdWVzdERhdGEsXG4gICAgaXNJUENFcnJvclJlc3BvbnNlLFxuICAgIElQQ1RyYW5zcG9ydEV2ZW50cyxcbiAgICBJUENUcmFuc3BvcnQsXG59IGZyb20gJy4vaW50ZXJmYWNlcyc7XG5cblxuaW50ZXJmYWNlIFJlcXVlc3RPcHRpb25zIHtcbiAgICBkYXRhOiBJUENSZXF1ZXN0RGF0YTtcbiAgICBzeW5jOiBib29sZWFuO1xufVxuXG5leHBvcnQgY2xhc3MgSVBDUHJveHkgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICAgIHByaXZhdGUgX3RyYW5zcG9ydDogSVBDVHJhbnNwb3J0O1xuICAgIHByaXZhdGUgX3JlcXVlc3RDb3VudGVyOiBudW1iZXIgPSAwO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgX2hhbmRsZXJzOiB7IFtuYW1lOiBzdHJpbmddOiBGdW5jdGlvbiB9O1xuXG4gICAgcHVibGljIGNvbnN0cnVjdG9yICh0cmFuc3BvcnQ6IElQQ1RyYW5zcG9ydCkge1xuICAgICAgICBzdXBlcigpO1xuXG4gICAgICAgIHRoaXMuX3RyYW5zcG9ydCA9IHRyYW5zcG9ydDtcblxuICAgICAgICB0aGlzLl9oYW5kbGVycyA9IHt9O1xuXG4gICAgICAgIHRoaXMuX3RyYW5zcG9ydC5yZWFkKCk7XG4gICAgICAgIHRoaXMuX3RyYW5zcG9ydC5vbihJUENUcmFuc3BvcnRFdmVudHMuZGF0YSwgcmF3UGFja2V0ID0+IHRoaXMuX29uUmVhZChyYXdQYWNrZXQpKTtcbiAgICAgICAgdGhpcy5vbigncmVxdWVzdCcsIGRhdGEgPT4gdGhpcy5fb25SZXF1ZXN0KGRhdGEpKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9vblJlYWQgKHBhY2tldDogSVBDUGFja2V0KTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGlmIChwYWNrZXQudHlwZSA9PT0gSVBDUGFja2V0VHlwZS5yZXNwb25zZSlcbiAgICAgICAgICAgIHRoaXMuZW1pdChgcmVzcG9uc2UtJHtwYWNrZXQuaWR9YCwgcGFja2V0KTtcbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgdGhpcy5lbWl0KCdyZXF1ZXN0JywgcGFja2V0KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9vblJlcXVlc3QgKHJlcXVlc3RQYWNrZXQ6IElQQ1JlcXVlc3RQYWNrZXQpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgbGV0IHJlc3VsdERhdGEgPSBudWxsO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICByZXN1bHREYXRhID0geyByZXN1bHQ6IGF3YWl0IHRoaXMuX2hhbmRsZXJzW3JlcXVlc3RQYWNrZXQuZGF0YS5uYW1lXSguLi5yZXF1ZXN0UGFja2V0LmRhdGEuYXJncykgfTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHJlc3VsdERhdGEgPSB7IGVycm9yIH07XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByZXNwb25zZVBhY2tldDogSVBDUmVzcG9uc2VQYWNrZXQgPSB7XG4gICAgICAgICAgICBpZDogICByZXF1ZXN0UGFja2V0LmlkLFxuICAgICAgICAgICAgdHlwZTogSVBDUGFja2V0VHlwZS5yZXNwb25zZSxcbiAgICAgICAgICAgIHN5bmM6IHJlcXVlc3RQYWNrZXQuc3luYyxcblxuICAgICAgICAgICAgZGF0YTogcmVzdWx0RGF0YSxcbiAgICAgICAgfTtcblxuICAgICAgICBhd2FpdCB0aGlzLl90cmFuc3BvcnQud3JpdGUocmVzcG9uc2VQYWNrZXQpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2NyZWF0ZVBhY2tldCAob3B0czogUmVxdWVzdE9wdGlvbnMpOiBJUENSZXF1ZXN0UGFja2V0IHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGlkOiAgIHRoaXMuX3JlcXVlc3RDb3VudGVyKyssXG4gICAgICAgICAgICB0eXBlOiBJUENQYWNrZXRUeXBlLnJlcXVlc3QsXG4gICAgICAgICAgICBzeW5jOiBvcHRzLnN5bmMsXG4gICAgICAgICAgICBkYXRhOiBvcHRzLmRhdGEsXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfY3JlYXRlUGxhaW5FcnJvciAoZXJyb3JEYXRhOiBFcnJvcik6IEVycm9yIHtcbiAgICAgICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoZXJyb3JEYXRhLm1lc3NhZ2UpO1xuXG4gICAgICAgIE9iamVjdC5hc3NpZ24oZXJyb3IsIGVycm9yRGF0YSk7XG5cbiAgICAgICAgcmV0dXJuIGVycm9yO1xuICAgIH1cblxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG4gICAgcHVibGljIHJlZ2lzdGVyIChmdW5jOiBGdW5jdGlvbiB8IEZ1bmN0aW9uW10sIGNvbnRleHQ6IGFueSA9IG51bGwpOiB2b2lkIHtcbiAgICAgICAgZnVuYyA9IGNhc3RBcnJheShmdW5jKTtcblxuICAgICAgICBmdW5jLmZvckVhY2goZm4gPT4ge1xuICAgICAgICAgICAgaWYgKHRoaXMuX2hhbmRsZXJzW2ZuLm5hbWVdKVxuICAgICAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICAgICAgdGhpcy5faGFuZGxlcnNbZm4ubmFtZV0gPSBmbi5iaW5kKGNvbnRleHQpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICAgIHB1YmxpYyBhc3luYyBjYWxsICh0YXJnZXQ6IHN0cmluZ3xGdW5jdGlvbiwgLi4uYXJnczogYW55W10pOiBQcm9taXNlPGFueT4ge1xuICAgICAgICBjb25zdCBuYW1lICAgICAgICAgICAgPSB0eXBlb2YgdGFyZ2V0ID09PSAnc3RyaW5nJyA/IHRhcmdldCA6IHRhcmdldC5uYW1lO1xuICAgICAgICBjb25zdCBwYWNrZXQgICAgICAgICAgPSB0aGlzLl9jcmVhdGVQYWNrZXQoeyBkYXRhOiB7IG5hbWUsIGFyZ3MgfSwgc3luYzogZmFsc2UgfSk7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlUHJvbWlzZSA9IHRoaXMub25jZShgcmVzcG9uc2UtJHtwYWNrZXQuaWR9YCk7XG5cbiAgICAgICAgYXdhaXQgdGhpcy5fdHJhbnNwb3J0LndyaXRlKHBhY2tldCk7XG5cbiAgICAgICAgY29uc3QgeyBkYXRhIH0gPSBhd2FpdCByZXNwb25zZVByb21pc2U7XG5cbiAgICAgICAgaWYgKGlzSVBDRXJyb3JSZXNwb25zZShkYXRhKSlcbiAgICAgICAgICAgIHRocm93IGRhdGEuZXJyb3I7XG5cbiAgICAgICAgcmV0dXJuIGRhdGEucmVzdWx0O1xuICAgIH1cblxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG4gICAgcHVibGljIGNhbGxTeW5jICh0YXJnZXQ6IHN0cmluZ3xGdW5jdGlvbiwgLi4uYXJnczogYW55W10pOiBhbnkge1xuICAgICAgICBjb25zdCBuYW1lICAgICAgICAgID0gdHlwZW9mIHRhcmdldCA9PT0gJ3N0cmluZycgPyB0YXJnZXQgOiB0YXJnZXQubmFtZTtcbiAgICAgICAgY29uc3QgcmVxdWVzdFBhY2tldCA9IHRoaXMuX2NyZWF0ZVBhY2tldCh7IGRhdGE6IHsgbmFtZSwgYXJncyB9LCBzeW5jOiB0cnVlIH0pO1xuXG4gICAgICAgIHRoaXMuX3RyYW5zcG9ydC53cml0ZVN5bmMocmVxdWVzdFBhY2tldCk7XG5cbiAgICAgICAgbGV0IHJlc3BvbnNlUGFja2V0OiBJUENSZXNwb25zZVBhY2tldCA9IHRoaXMuX3RyYW5zcG9ydC5yZWFkU3luYygpO1xuXG4gICAgICAgIHdoaWxlIChyZXNwb25zZVBhY2tldC5pZCAhPT0gcmVxdWVzdFBhY2tldC5pZClcbiAgICAgICAgICAgIHJlc3BvbnNlUGFja2V0ID0gdGhpcy5fdHJhbnNwb3J0LnJlYWRTeW5jKCk7XG5cbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSByZXNwb25zZVBhY2tldC5kYXRhO1xuXG4gICAgICAgIGlmIChpc0lQQ0Vycm9yUmVzcG9uc2UocmVzcG9uc2UpKVxuICAgICAgICAgICAgdGhyb3cgcmVzcG9uc2UuZXJyb3I7XG5cbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnJlc3VsdDtcbiAgICB9XG59XG4iXX0=