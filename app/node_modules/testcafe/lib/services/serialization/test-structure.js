"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.restore = exports.serialize = exports.flatten = exports.isFixture = exports.isTest = void 0;
const lodash_1 = require("lodash");
const protocol_1 = require("../compiler/protocol");
const unit_type_1 = __importDefault(require("../../api/structure/unit-type"));
const RECURSIVE_PROPERTIES = ['testFile', 'fixture', 'currentFixture', 'collectedTests'];
function isProperty(object, property) {
    return object.hasOwnProperty(property);
}
function isTest(value) {
    return value.unitType === unit_type_1.default.test;
}
exports.isTest = isTest;
function isFixture(value) {
    return value.unitType === unit_type_1.default.fixture;
}
exports.isFixture = isFixture;
function mapProperties(object, properties, mapper) {
    for (const property of properties) {
        if (!isProperty(object, property))
            continue;
        const value = object[property];
        if (Array.isArray(value))
            object[property] = value.map(item => mapper({ item, property, object }));
        else
            object[property] = mapper({ item: object[property], property, object });
    }
}
function replaceFunctionProperties(unit) {
    mapProperties(unit, protocol_1.FUNCTION_PROPERTIES, ({ item }) => !!item);
}
function restoreFunctionProperties(unit, mapper) {
    mapProperties(unit, protocol_1.FUNCTION_PROPERTIES, ({ item, object, property }) => item ? mapper(object.id, property) : item);
}
function flattenRecursiveProperties(unit) {
    mapProperties(unit, RECURSIVE_PROPERTIES, ({ item }) => item.id);
}
function restoreRecursiveProperties(unit, units) {
    mapProperties(unit, RECURSIVE_PROPERTIES, ({ item }) => units[item]);
}
function restorePredicateInRequestFilterRules(test, mapper) {
    test.requestHooks.forEach(hook => {
        for (let i = 0; i < hook._requestFilterRules.length; i++) {
            const targetRule = hook._requestFilterRules[i];
            if (!targetRule.isPredicate)
                continue;
            targetRule.options = mapper({
                testId: test.id,
                hookId: hook.id,
                ruleId: targetRule.id,
            });
        }
    });
}
function flatten(tests) {
    const testFiles = lodash_1.uniq(tests.map(test => test.testFile));
    const fixtures = lodash_1.uniq(tests.map(test => test.fixture));
    return lodash_1.keyBy([...tests, ...fixtures, ...testFiles], unit => unit.id);
}
exports.flatten = flatten;
function serialize(units) {
    const result = {};
    for (const unit of Object.values(units)) {
        // @ts-ignore
        const copy = Object.assign({}, unit);
        replaceFunctionProperties(copy);
        flattenRecursiveProperties(copy);
        result[copy.id] = copy;
    }
    return result;
}
exports.serialize = serialize;
function restore(units, testFunctionMapper, ruleMapper) {
    const list = Object.values(units);
    const result = [];
    for (const unit of list) {
        restoreRecursiveProperties(unit, units);
        restoreFunctionProperties(unit, testFunctionMapper);
        if (isTest(unit)) {
            restorePredicateInRequestFilterRules(unit, ruleMapper);
            result.push(unit);
        }
    }
    return result;
}
exports.restore = restore;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC1zdHJ1Y3R1cmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvc2VydmljZXMvc2VyaWFsaXphdGlvbi90ZXN0LXN0cnVjdHVyZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxtQ0FBcUM7QUFDckMsbURBQTJEO0FBSzNELDhFQUFxRDtBQUlyRCxNQUFNLG9CQUFvQixHQUFHLENBQUMsVUFBVSxFQUFFLFNBQVMsRUFBRSxnQkFBZ0IsRUFBRSxnQkFBZ0IsQ0FBVSxDQUFDO0FBMEJsRyxTQUFTLFVBQVUsQ0FBb0IsTUFBUyxFQUFFLFFBQWdCO0lBQzlELE9BQU8sTUFBTSxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUMzQyxDQUFDO0FBRUQsU0FBZ0IsTUFBTSxDQUFFLEtBQVc7SUFDL0IsT0FBTyxLQUFLLENBQUMsUUFBUSxLQUFLLG1CQUFRLENBQUMsSUFBSSxDQUFDO0FBQzVDLENBQUM7QUFGRCx3QkFFQztBQUVELFNBQWdCLFNBQVMsQ0FBRSxLQUFXO0lBQ2xDLE9BQU8sS0FBSyxDQUFDLFFBQVEsS0FBSyxtQkFBUSxDQUFDLE9BQU8sQ0FBQztBQUMvQyxDQUFDO0FBRkQsOEJBRUM7QUFFRCxTQUFTLGFBQWEsQ0FBNEQsTUFBUyxFQUFFLFVBQWEsRUFBRSxNQUE0QjtJQUNwSSxLQUFLLE1BQU0sUUFBUSxJQUFJLFVBQVUsRUFBRTtRQUMvQixJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxRQUFRLENBQUM7WUFDN0IsU0FBUztRQUViLE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUUvQixJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDO1lBQ3BCLE1BQU0sQ0FBQyxRQUFRLENBQUMsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxNQUFN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QUM7UUFFL0IseUJBQXlCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDaEMsMEJBQTBCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFakMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUM7S0FDMUI7SUFFRCxPQUFPLE1BQU0sQ0FBQztBQUNsQixDQUFDO0FBZEQsOEJBY0M7QUFFRCxTQUFnQixPQUFPLENBQUUsS0FBWSxFQUFFLGtCQUFrQyxFQUFFLFVBQW1DO0lBQzFHLE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7SUFFbEMsTUFBTSxNQUFNLEdBQVcsRUFBRSxDQUFDO0lBRTFCLEtBQUssTUFBTSxJQUFJLElBQUksSUFBSSxFQUFFO1FBQ3JCLDBCQUEwQixDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztRQUN4Qyx5QkFBeUIsQ0FBQyxJQUFJLEVBQUUsa0JBQWtCLENBQUMsQ0FBQztRQUVwRCxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUNkLG9DQUFvQyxDQUFDLElBQUksRUFBRSxVQUFVLENBQUMsQ0FBQztZQUV2RCxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ3JCO0tBQ0o7SUFFRCxPQUFPLE1BQU0sQ0FBQztBQUNsQixDQUFDO0FBakJELDBCQWlCQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHVuaXEsIGtleUJ5IH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IEZVTkNUSU9OX1BST1BFUlRJRVMgfSBmcm9tICcuLi9jb21waWxlci9wcm90b2NvbCc7XG5pbXBvcnQgeyBSZXF1ZXN0RmlsdGVyUnVsZUxvY2F0b3IgfSBmcm9tICcuLi9jb21waWxlci9pbnRlcmZhY2VzJztcbmltcG9ydCBUZXN0IGZyb20gJy4uLy4uL2FwaS9zdHJ1Y3R1cmUvdGVzdCc7XG5pbXBvcnQgRml4dHVyZSBmcm9tICcuLi8uLi9hcGkvc3RydWN0dXJlL2ZpeHR1cmUnO1xuaW1wb3J0IFRlc3RGaWxlIGZyb20gJy4uLy4uL2FwaS9zdHJ1Y3R1cmUvdGVzdC1maWxlJztcbmltcG9ydCBVbml0VHlwZSBmcm9tICcuLi8uLi9hcGkvc3RydWN0dXJlL3VuaXQtdHlwZSc7XG5pbXBvcnQgeyBSZXF1ZXN0SW5mbyB9IGZyb20gJ3Rlc3RjYWZlLWhhbW1lcmhlYWQnO1xuXG5cbmNvbnN0IFJFQ1VSU0lWRV9QUk9QRVJUSUVTID0gWyd0ZXN0RmlsZScsICdmaXh0dXJlJywgJ2N1cnJlbnRGaXh0dXJlJywgJ2NvbGxlY3RlZFRlc3RzJ10gYXMgY29uc3Q7XG5cbmludGVyZmFjZSBGdW5jdGlvbk1hcHBlciB7XG4gICAgKGlkOiBzdHJpbmcsIGZ1bmN0aW9uTmFtZTogdHlwZW9mIEZVTkNUSU9OX1BST1BFUlRJRVNbbnVtYmVyXSk6IEZ1bmN0aW9uO1xufVxuXG5pbnRlcmZhY2UgUmVxdWVzdEZpbHRlclJ1bGVNYXBwZXIge1xuICAgIChydWxlTG9jYXRvcjogUmVxdWVzdEZpbHRlclJ1bGVMb2NhdG9yKTogKHJlcXVlc3RJbmZvOiBSZXF1ZXN0SW5mbykgPT4gUHJvbWlzZTxib29sZWFuPjtcbn1cblxuaW50ZXJmYWNlIE1hcHBlckFyZ3VtZW50czxULCBQPiB7XG4gICAgb2JqZWN0OiBUO1xuICAgIHByb3BlcnR5OiBQO1xuICAgIGl0ZW06IGFueTtcbn1cblxuaW50ZXJmYWNlIE1hcHBlcjxULCBQPiB7XG4gICAgKHsgaXRlbSwgcHJvcGVydHksIG9iamVjdCB9OiBNYXBwZXJBcmd1bWVudHM8VCwgUD4pOiBhbnk7XG59XG5cbmV4cG9ydCB0eXBlIFVuaXQgPSBUZXN0IHwgRml4dHVyZSB8IFRlc3RGaWxlO1xuXG5leHBvcnQgaW50ZXJmYWNlIFVuaXRzIHtcbiAgICBbaWQ6IHN0cmluZ106IFVuaXQ7XG59XG5cbmZ1bmN0aW9uIGlzUHJvcGVydHk8VCBleHRlbmRzIG9iamVjdD4gKG9iamVjdDogVCwgcHJvcGVydHk6IHN0cmluZyk6IHByb3BlcnR5IGlzIEV4dHJhY3Q8a2V5b2YgVCwgc3RyaW5nPiB7XG4gICAgcmV0dXJuIG9iamVjdC5oYXNPd25Qcm9wZXJ0eShwcm9wZXJ0eSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc1Rlc3QgKHZhbHVlOiBVbml0KTogdmFsdWUgaXMgVGVzdCB7XG4gICAgcmV0dXJuIHZhbHVlLnVuaXRUeXBlID09PSBVbml0VHlwZS50ZXN0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNGaXh0dXJlICh2YWx1ZTogVW5pdCk6IHZhbHVlIGlzIEZpeHR1cmUge1xuICAgIHJldHVybiB2YWx1ZS51bml0VHlwZSA9PT0gVW5pdFR5cGUuZml4dHVyZTtcbn1cblxuZnVuY3Rpb24gbWFwUHJvcGVydGllczxUIGV4dGVuZHMgUmVhZG9ubHk8b2JqZWN0PiwgUCBleHRlbmRzIFJlYWRvbmx5PHN0cmluZ1tdPj4gKG9iamVjdDogVCwgcHJvcGVydGllczogUCwgbWFwcGVyOiBNYXBwZXI8VCwgUFtudW1iZXJdPik6IHZvaWQge1xuICAgIGZvciAoY29uc3QgcHJvcGVydHkgb2YgcHJvcGVydGllcykge1xuICAgICAgICBpZiAoIWlzUHJvcGVydHkob2JqZWN0LCBwcm9wZXJ0eSkpXG4gICAgICAgICAgICBjb250aW51ZTtcblxuICAgICAgICBjb25zdCB2YWx1ZSA9IG9iamVjdFtwcm9wZXJ0eV07XG5cbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKVxuICAgICAgICAgICAgb2JqZWN0W3Byb3BlcnR5XSA9IHZhbHVlLm1hcChpdGVtID0+IG1hcHBlcih7IGl0ZW0sIHByb3BlcnR5LCBvYmplY3QgfSkpIGFzIGFueTtcbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgb2JqZWN0W3Byb3BlcnR5XSA9IG1hcHBlcih7IGl0ZW06IG9iamVjdFtwcm9wZXJ0eV0sIHByb3BlcnR5LCBvYmplY3QgfSk7XG4gICAgfVxufVxuXG5mdW5jdGlvbiByZXBsYWNlRnVuY3Rpb25Qcm9wZXJ0aWVzICh1bml0OiBVbml0KTogdm9pZCB7XG4gICAgbWFwUHJvcGVydGllcyh1bml0LCBGVU5DVElPTl9QUk9QRVJUSUVTLCAoeyBpdGVtIH0pID0+ICEhaXRlbSk7XG59XG5cbmZ1bmN0aW9uIHJlc3RvcmVGdW5jdGlvblByb3BlcnRpZXMgKHVuaXQ6IFVuaXQsIG1hcHBlcjogRnVuY3Rpb25NYXBwZXIpOiB2b2lkIHtcbiAgICBtYXBQcm9wZXJ0aWVzKHVuaXQsIEZVTkNUSU9OX1BST1BFUlRJRVMsICh7IGl0ZW0sIG9iamVjdCwgcHJvcGVydHkgfSkgPT4gaXRlbSA/IG1hcHBlcihvYmplY3QuaWQsIHByb3BlcnR5KSA6IGl0ZW0pO1xufVxuXG5mdW5jdGlvbiBmbGF0dGVuUmVjdXJzaXZlUHJvcGVydGllcyAodW5pdDogVW5pdCk6IHZvaWQge1xuICAgIG1hcFByb3BlcnRpZXModW5pdCwgUkVDVVJTSVZFX1BST1BFUlRJRVMsICh7IGl0ZW0gfSkgPT4gaXRlbS5pZCk7XG59XG5cbmZ1bmN0aW9uIHJlc3RvcmVSZWN1cnNpdmVQcm9wZXJ0aWVzICh1bml0OiBVbml0LCB1bml0czogVW5pdHMpOiB2b2lkIHtcbiAgICBtYXBQcm9wZXJ0aWVzKHVuaXQsIFJFQ1VSU0lWRV9QUk9QRVJUSUVTLCAoeyBpdGVtIH0pID0+IHVuaXRzW2l0ZW1dKTtcbn1cblxuZnVuY3Rpb24gcmVzdG9yZVByZWRpY2F0ZUluUmVxdWVzdEZpbHRlclJ1bGVzICh0ZXN0OiBUZXN0LCBtYXBwZXI6IFJlcXVlc3RGaWx0ZXJSdWxlTWFwcGVyKTogdm9pZCB7XG4gICAgdGVzdC5yZXF1ZXN0SG9va3MuZm9yRWFjaChob29rID0+IHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBob29rLl9yZXF1ZXN0RmlsdGVyUnVsZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGNvbnN0IHRhcmdldFJ1bGUgPSBob29rLl9yZXF1ZXN0RmlsdGVyUnVsZXNbaV07XG5cbiAgICAgICAgICAgIGlmICghdGFyZ2V0UnVsZS5pc1ByZWRpY2F0ZSlcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcblxuICAgICAgICAgICAgdGFyZ2V0UnVsZS5vcHRpb25zID0gbWFwcGVyKHtcbiAgICAgICAgICAgICAgICB0ZXN0SWQ6IHRlc3QuaWQsXG4gICAgICAgICAgICAgICAgaG9va0lkOiBob29rLmlkLFxuICAgICAgICAgICAgICAgIHJ1bGVJZDogdGFyZ2V0UnVsZS5pZCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmbGF0dGVuICh0ZXN0czogVGVzdFtdKTogVW5pdHMge1xuICAgIGNvbnN0IHRlc3RGaWxlcyA9IHVuaXEodGVzdHMubWFwKHRlc3QgPT4gdGVzdC50ZXN0RmlsZSkpO1xuICAgIGNvbnN0IGZpeHR1cmVzICA9IHVuaXEodGVzdHMubWFwKHRlc3QgPT4gdGVzdC5maXh0dXJlKSk7XG5cbiAgICByZXR1cm4ga2V5QnkoWy4uLnRlc3RzLCAuLi5maXh0dXJlcywgLi4udGVzdEZpbGVzXSwgdW5pdCA9PiB1bml0LmlkKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNlcmlhbGl6ZSAodW5pdHM6IFVuaXRzKTogVW5pdHMge1xuICAgIGNvbnN0IHJlc3VsdDogVW5pdHMgPSB7fTtcblxuICAgIGZvciAoY29uc3QgdW5pdCBvZiBPYmplY3QudmFsdWVzKHVuaXRzKSkge1xuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIGNvbnN0IGNvcHk6IFVuaXQgPSB7IC4uLnVuaXQgfTtcblxuICAgICAgICByZXBsYWNlRnVuY3Rpb25Qcm9wZXJ0aWVzKGNvcHkpO1xuICAgICAgICBmbGF0dGVuUmVjdXJzaXZlUHJvcGVydGllcyhjb3B5KTtcblxuICAgICAgICByZXN1bHRbY29weS5pZF0gPSBjb3B5O1xuICAgIH1cblxuICAgIHJldHVybiByZXN1bHQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZXN0b3JlICh1bml0czogVW5pdHMsIHRlc3RGdW5jdGlvbk1hcHBlcjogRnVuY3Rpb25NYXBwZXIsIHJ1bGVNYXBwZXI6IFJlcXVlc3RGaWx0ZXJSdWxlTWFwcGVyKTogVGVzdFtdIHtcbiAgICBjb25zdCBsaXN0ID0gT2JqZWN0LnZhbHVlcyh1bml0cyk7XG5cbiAgICBjb25zdCByZXN1bHQ6IFRlc3RbXSA9IFtdO1xuXG4gICAgZm9yIChjb25zdCB1bml0IG9mIGxpc3QpIHtcbiAgICAgICAgcmVzdG9yZVJlY3Vyc2l2ZVByb3BlcnRpZXModW5pdCwgdW5pdHMpO1xuICAgICAgICByZXN0b3JlRnVuY3Rpb25Qcm9wZXJ0aWVzKHVuaXQsIHRlc3RGdW5jdGlvbk1hcHBlcik7XG5cbiAgICAgICAgaWYgKGlzVGVzdCh1bml0KSkge1xuICAgICAgICAgICAgcmVzdG9yZVByZWRpY2F0ZUluUmVxdWVzdEZpbHRlclJ1bGVzKHVuaXQsIHJ1bGVNYXBwZXIpO1xuXG4gICAgICAgICAgICByZXN1bHQucHVzaCh1bml0KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiByZXN1bHQ7XG59XG4iXX0=