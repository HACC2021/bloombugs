"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const errors_1 = require("../../../../../../shared/errors");
const EXECUTION_CTX_WAS_DESTROYED_CODE = -32000;
const SELECTOR_MAX_EXECUTE_COUNT = 10;
const PROXYLESS_SCRIPT = 'window["%proxyless%"]';
class ClientFunctionExecutor {
    constructor() {
        // new Map<frameId, executionContextId>
        this._frameExecutionContexts = new Map();
        this._currentFrameId = '';
    }
    async evaluateScript(Runtime, expression) {
        const script = { expression, awaitPromise: true };
        if (this._currentFrameId && this._frameExecutionContexts.has(this._currentFrameId))
            script.contextId = this._frameExecutionContexts.get(this._currentFrameId);
        try {
            const { result, exceptionDetails = null } = await Runtime.evaluate(script);
            return { result, exceptionDetails, error: null };
        }
        catch (error) {
            return { result: null, exceptionDetails: null, error };
        }
    }
    async _evaluateScriptWithReloadPageIgnore(Runtime, expression) {
        let attempts = 0;
        let result;
        let exceptionDetails;
        let error;
        while (attempts++ < SELECTOR_MAX_EXECUTE_COUNT) {
            ({ result, exceptionDetails, error } = await this.evaluateScript(Runtime, expression));
            if (error && error.response.code === EXECUTION_CTX_WAS_DESTROYED_CODE)
                continue;
            break;
        }
        // eslint-disable-next-line @typescript-eslint/no-object-literal-type-assertion
        return { result, exceptionDetails, error };
    }
    static _getPropertyByName(properties, name) {
        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
        return properties.find(prop => prop.name === name).value;
    }
    static _throwException(details, command, callsite) {
        var _a;
        const exception = details.exception;
        if (exception) {
            const className = exception.className;
            const properties = (_a = exception.preview) === null || _a === void 0 ? void 0 : _a.properties;
            if (className === errors_1.UncaughtErrorInCustomDOMPropertyCode.name) {
                throw new errors_1.UncaughtErrorInCustomDOMPropertyCode(command.instantiationCallsiteName, ClientFunctionExecutor._getPropertyByName(properties, 'errMsg'), ClientFunctionExecutor._getPropertyByName(properties, 'property'), callsite);
            }
            else if (className === errors_1.CannotObtainInfoForElementSpecifiedBySelectorError.name) {
                throw new errors_1.CannotObtainInfoForElementSpecifiedBySelectorError(callsite, {
                    apiFnChain: command.apiFnChain,
                    apiFnIndex: parseInt(ClientFunctionExecutor._getPropertyByName(properties, 'apiFnIndex'), 10),
                });
            }
            else if (className === errors_1.DomNodeClientFunctionResultError.name)
                throw new errors_1.DomNodeClientFunctionResultError(command.instantiationCallsiteName, callsite);
            else if (className === errors_1.InvalidSelectorResultError.name)
                throw new errors_1.InvalidSelectorResultError(callsite);
        }
        throw new errors_1.UncaughtErrorInClientFunctionCode(command.instantiationCallsiteName, details.text, callsite);
    }
    async executeClientFunction(Runtime, command, callsite) {
        const expression = `${PROXYLESS_SCRIPT}.executeClientFunctionCommand(${JSON.stringify(command)});`;
        const { result, exceptionDetails, error } = await this.evaluateScript(Runtime, expression);
        if (error) {
            if (error.response.code === EXECUTION_CTX_WAS_DESTROYED_CODE)
                throw new errors_1.ClientFunctionExecutionInterruptionError(command.instantiationCallsiteName, callsite);
            throw error;
        }
        if (exceptionDetails)
            ClientFunctionExecutor._throwException(exceptionDetails, command, callsite);
        return JSON.parse(result.value); // eslint-disable-line @typescript-eslint/no-non-null-assertion
    }
    async executeSelector(Runtime, command, callsite, selectorTimeout) {
        const expression = `${PROXYLESS_SCRIPT}.executeSelectorCommand(${JSON.stringify(command)}, ${selectorTimeout}, ${Date.now()});`;
        const { result, exceptionDetails, error } = await this._evaluateScriptWithReloadPageIgnore(Runtime, expression);
        if (error)
            throw error;
        if (exceptionDetails)
            ClientFunctionExecutor._throwException(exceptionDetails, command, callsite);
        return JSON.parse(result.value); // eslint-disable-line @typescript-eslint/no-non-null-assertion
    }
    setupFramesWatching(Runtime) {
        Runtime.on('executionContextCreated', (event) => {
            var _a;
            if (!((_a = event.context.auxData) === null || _a === void 0 ? void 0 : _a.frameId))
                return;
            this._frameExecutionContexts.set(event.context.auxData.frameId, event.context.id);
        });
        Runtime.on('executionContextDestroyed', (event) => {
            for (const [frameId, executionContextId] of this._frameExecutionContexts.entries()) {
                if (executionContextId === event.executionContextId)
                    this._frameExecutionContexts.delete(frameId);
            }
        });
        Runtime.on('executionContextsCleared', () => {
            this._currentFrameId = '';
            this._frameExecutionContexts.clear();
        });
    }
    setCurrentFrameId(frameId) {
        this._currentFrameId = frameId;
    }
}
exports.default = ClientFunctionExecutor;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpZW50LWZ1bmN0aW9uLWV4ZWN1dG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2Jyb3dzZXIvcHJvdmlkZXIvYnVpbHQtaW4vZGVkaWNhdGVkL2Nocm9tZS9jZHAtY2xpZW50L2NsaWVudC1mdW5jdGlvbi1leGVjdXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQVFBLDREQUt5QztBQW9CekMsTUFBTSxnQ0FBZ0MsR0FBRyxDQUFDLEtBQUssQ0FBQztBQUNoRCxNQUFNLDBCQUEwQixHQUFTLEVBQUUsQ0FBQztBQUM1QyxNQUFNLGdCQUFnQixHQUFtQix1QkFBdUIsQ0FBQztBQUdqRSxNQUFxQixzQkFBc0I7SUFBM0M7UUFDSSx1Q0FBdUM7UUFDdEIsNEJBQXVCLEdBQUcsSUFBSSxHQUFHLEVBQWtCLENBQUM7UUFDN0Qsb0JBQWUsR0FBVyxFQUFFLENBQUM7SUE4SHpDLENBQUM7SUE1SFUsS0FBSyxDQUFDLGNBQWMsQ0FBRSxPQUFtQixFQUFFLFVBQWtCO1FBQ2hFLE1BQU0sTUFBTSxHQUFvQixFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQUUsSUFBSSxFQUFFLENBQUM7UUFFbkUsSUFBSSxJQUFJLENBQUMsZUFBZSxJQUFJLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQztZQUM5RSxNQUFNLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBRTlFLElBQUk7WUFDQSxNQUFNLEVBQUUsTUFBTSxFQUFFLGdCQUFnQixHQUFHLElBQUksRUFBRSxHQUFHLE1BQU0sT0FBTyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUUzRSxPQUFPLEVBQUUsTUFBTSxFQUFFLGdCQUFnQixFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQztTQUNwRDtRQUNELE9BQU8sS0FBSyxFQUFFO1lBQ1YsT0FBTyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsZ0JBQWdCLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxDQUFDO1NBQzFEO0lBQ0wsQ0FBQztJQUVPLEtBQUssQ0FBQyxtQ0FBbUMsQ0FBRSxPQUFtQixFQUFFLFVBQWtCO1FBQ3RGLElBQUksUUFBUSxHQUFHLENBQUMsQ0FBQztRQUNqQixJQUFJLE1BQU0sQ0FBQztRQUNYLElBQUksZ0JBQWdCLENBQUM7UUFDckIsSUFBSSxLQUFLLENBQUM7UUFFVixPQUFPLFFBQVEsRUFBRSxHQUFHLDBCQUEwQixFQUFFO1lBQzVDLENBQUMsRUFBRSxNQUFNLEVBQUUsZ0JBQWdCLEVBQUUsS0FBSyxFQUFFLEdBQUcsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sRUFBRSxVQUFVLENBQUMsQ0FBQyxDQUFDO1lBRXZGLElBQUksS0FBSyxJQUFJLEtBQUssQ0FBQyxRQUFRLENBQUMsSUFBSSxLQUFLLGdDQUFnQztnQkFDakUsU0FBUztZQUViLE1BQU07U0FDVDtRQUVELCtFQUErRTtRQUMvRSxPQUFPLEVBQUUsTUFBTSxFQUFFLGdCQUFnQixFQUFFLEtBQUssRUFBMEIsQ0FBQztJQUN2RSxDQUFDO0lBRU8sTUFBTSxDQUFDLGtCQUFrQixDQUFFLFVBQTZCLEVBQUUsSUFBWTtRQUMxRSxvRUFBb0U7UUFDcEUsT0FBTyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksS0FBSyxJQUFJLENBQUUsQ0FBQyxLQUFNLENBQUM7SUFDL0QsQ0FBQztJQUVPLE1BQU0sQ0FBQyxlQUFlLENBQUUsT0FBeUIsRUFBRSxPQUF5QyxFQUFFLFFBQXdCOztRQUMxSCxNQUFNLFNBQVMsR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDO1FBRXBDLElBQUksU0FBUyxFQUFFO1lBQ1gsTUFBTSxTQUFTLEdBQUksU0FBUyxDQUFDLFNBQVMsQ0FBQztZQUN2QyxNQUFNLFVBQVUsR0FBRyxNQUFBLFNBQVMsQ0FBQyxPQUFPLDBDQUFFLFVBQStCLENBQUM7WUFFdEUsSUFBSSxTQUFTLEtBQUssNkNBQW9DLENBQUMsSUFBSSxFQUFFO2dCQUN6RCxNQUFNLElBQUksNkNBQW9DLENBQUMsT0FBTyxDQUFDLHlCQUF5QixFQUM1RSxzQkFBc0IsQ0FBQyxrQkFBa0IsQ0FBQyxVQUFVLEVBQUUsUUFBUSxDQUFDLEVBQy9ELHNCQUFzQixDQUFDLGtCQUFrQixDQUFDLFVBQVUsRUFBRSxVQUFVLENBQUMsRUFDakUsUUFBUSxDQUFDLENBQUM7YUFDakI7aUJBQ0ksSUFBSSxTQUFTLEtBQUssMkRBQWtELENBQUMsSUFBSSxFQUFFO2dCQUM1RSxNQUFNLElBQUksMkRBQWtELENBQUMsUUFBUSxFQUFFO29CQUNuRSxVQUFVLEVBQUUsT0FBTyxDQUFDLFVBQVU7b0JBQzlCLFVBQVUsRUFBRSxRQUFRLENBQUMsc0JBQXNCLENBQUMsa0JBQWtCLENBQUMsVUFBVSxFQUFFLFlBQVksQ0FBQyxFQUFFLEVBQUUsQ0FBQztpQkFDaEcsQ0FBQyxDQUFDO2FBQ047aUJBQ0ksSUFBSSxTQUFTLEtBQUsseUNBQWdDLENBQUMsSUFBSTtnQkFDeEQsTUFBTSxJQUFJLHlDQUFnQyxDQUFDLE9BQU8sQ0FBQyx5QkFBeUIsRUFBRSxRQUFRLENBQUMsQ0FBQztpQkFDdkYsSUFBSSxTQUFTLEtBQUssbUNBQTBCLENBQUMsSUFBSTtnQkFDbEQsTUFBTSxJQUFJLG1DQUEwQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQ3REO1FBRUQsTUFBTSxJQUFJLDBDQUFpQyxDQUFDLE9BQU8sQ0FBQyx5QkFBeUIsRUFBRSxPQUFPLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQzNHLENBQUM7SUFFTSxLQUFLLENBQUMscUJBQXFCLENBQUUsT0FBbUIsRUFBRSxPQUFxQyxFQUFFLFFBQXdCO1FBQ3BILE1BQU0sVUFBVSxHQUFHLEdBQUcsZ0JBQWdCLGlDQUFpQyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUM7UUFFbkcsTUFBTSxFQUFFLE1BQU0sRUFBRSxnQkFBZ0IsRUFBRSxLQUFLLEVBQUUsR0FBRyxNQUFNLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBRTNGLElBQUksS0FBSyxFQUFFO1lBQ1AsSUFBSSxLQUFLLENBQUMsUUFBUSxDQUFDLElBQUksS0FBSyxnQ0FBZ0M7Z0JBQ3hELE1BQU0sSUFBSSxpREFBd0MsQ0FBQyxPQUFPLENBQUMseUJBQXlCLEVBQUUsUUFBUSxDQUFDLENBQUM7WUFFcEcsTUFBTSxLQUFLLENBQUM7U0FDZjtRQUVELElBQUksZ0JBQWdCO1lBQ2hCLHNCQUFzQixDQUFDLGVBQWUsQ0FBQyxnQkFBZ0IsRUFBRSxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFFaEYsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLCtEQUErRDtJQUNyRyxDQUFDO0lBRU0sS0FBSyxDQUFDLGVBQWUsQ0FBRSxPQUFtQixFQUFFLE9BQStCLEVBQUUsUUFBd0IsRUFBRSxlQUF1QjtRQUNqSSxNQUFNLFVBQVUsR0FBRyxHQUFHLGdCQUFnQiwyQkFBMkIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsS0FBSyxlQUFlLEtBQUssSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUM7UUFFaEksTUFBTSxFQUFFLE1BQU0sRUFBRSxnQkFBZ0IsRUFBRSxLQUFLLEVBQUUsR0FBRyxNQUFNLElBQUksQ0FBQyxtQ0FBbUMsQ0FBQyxPQUFPLEVBQUUsVUFBVSxDQUFDLENBQUM7UUFFaEgsSUFBSSxLQUFLO1lBQ0wsTUFBTSxLQUFLLENBQUM7UUFFaEIsSUFBSSxnQkFBZ0I7WUFDaEIsc0JBQXNCLENBQUMsZUFBZSxDQUFDLGdCQUFnQixFQUFFLE9BQU8sRUFBRSxRQUFRLENBQUMsQ0FBQztRQUVoRixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsK0RBQStEO0lBQ3JHLENBQUM7SUFFTSxtQkFBbUIsQ0FBRSxPQUFtQjtRQUMzQyxPQUFPLENBQUMsRUFBRSxDQUFDLHlCQUF5QixFQUFFLENBQUMsS0FBb0QsRUFBRSxFQUFFOztZQUMzRixJQUFJLFFBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxPQUFPLDBDQUFFLE9BQU8sQ0FBQTtnQkFDL0IsT0FBTztZQUVYLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDdEYsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLENBQUMsRUFBRSxDQUFDLDJCQUEyQixFQUFFLENBQUMsS0FBc0QsRUFBRSxFQUFFO1lBQy9GLEtBQUssTUFBTSxDQUFDLE9BQU8sRUFBRSxrQkFBa0IsQ0FBQyxJQUFJLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxPQUFPLEVBQUUsRUFBRTtnQkFDaEYsSUFBSSxrQkFBa0IsS0FBSyxLQUFLLENBQUMsa0JBQWtCO29CQUMvQyxJQUFJLENBQUMsdUJBQXVCLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2FBQ3BEO1FBQ0wsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLENBQUMsRUFBRSxDQUFDLDBCQUEwQixFQUFFLEdBQUcsRUFBRTtZQUN4QyxJQUFJLENBQUMsZUFBZSxHQUFHLEVBQUUsQ0FBQztZQUMxQixJQUFJLENBQUMsdUJBQXVCLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDekMsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRU0saUJBQWlCLENBQUUsT0FBZTtRQUNyQyxJQUFJLENBQUMsZUFBZSxHQUFHLE9BQU8sQ0FBQztJQUNuQyxDQUFDO0NBQ0o7QUFqSUQseUNBaUlDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFByb3RvY29sIGZyb20gJ2RldnRvb2xzLXByb3RvY29sJztcbmltcG9ydCB7IENhbGxzaXRlUmVjb3JkIH0gZnJvbSAnY2FsbHNpdGUtcmVjb3JkJztcbmltcG9ydCBQcm90b2NvbFByb3h5QXBpIGZyb20gJ2RldnRvb2xzLXByb3RvY29sL3R5cGVzL3Byb3RvY29sLXByb3h5LWFwaSc7XG5pbXBvcnQgUnVudGltZUFwaSA9IFByb3RvY29sUHJveHlBcGkuUnVudGltZUFwaTtcbmltcG9ydCBFdmFsdWF0ZVJlcXVlc3QgPSBQcm90b2NvbC5SdW50aW1lLkV2YWx1YXRlUmVxdWVzdDtcbmltcG9ydCBSZW1vdGVPYmplY3QgPSBQcm90b2NvbC5SdW50aW1lLlJlbW90ZU9iamVjdDtcbmltcG9ydCBFeGNlcHRpb25EZXRhaWxzID0gUHJvdG9jb2wuUnVudGltZS5FeGNlcHRpb25EZXRhaWxzO1xuaW1wb3J0IFByb3BlcnR5UHJldmlldyA9IFByb3RvY29sLlJ1bnRpbWUuUHJvcGVydHlQcmV2aWV3O1xuaW1wb3J0IHtcbiAgICBDYW5ub3RPYnRhaW5JbmZvRm9yRWxlbWVudFNwZWNpZmllZEJ5U2VsZWN0b3JFcnJvcixcbiAgICBDbGllbnRGdW5jdGlvbkV4ZWN1dGlvbkludGVycnVwdGlvbkVycm9yLCBEb21Ob2RlQ2xpZW50RnVuY3Rpb25SZXN1bHRFcnJvcixcbiAgICBJbnZhbGlkU2VsZWN0b3JSZXN1bHRFcnJvciwgVW5jYXVnaHRFcnJvckluQ2xpZW50RnVuY3Rpb25Db2RlLFxuICAgIFVuY2F1Z2h0RXJyb3JJbkN1c3RvbURPTVByb3BlcnR5Q29kZSxcbn0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vLi4vc2hhcmVkL2Vycm9ycyc7XG5pbXBvcnQge1xuICAgIEV4ZWN1dGVDbGllbnRGdW5jdGlvbkNvbW1hbmQsXG4gICAgRXhlY3V0ZUNsaWVudEZ1bmN0aW9uQ29tbWFuZEJhc2UsXG4gICAgRXhlY3V0ZVNlbGVjdG9yQ29tbWFuZCxcbn0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vLi4vdGVzdC1ydW4vY29tbWFuZHMvb2JzZXJ2YXRpb24nO1xuXG5cbmludGVyZmFjZSBFdmFsdWF0aW9uRXJyb3IgZXh0ZW5kcyBFcnJvciB7XG4gICAgcmVxdWVzdDogRXZhbHVhdGVSZXF1ZXN0O1xuICAgIHJlc3BvbnNlOiB7IGNvZGU6IG51bWJlciB9O1xufVxuXG5pbnRlcmZhY2UgRXZhbHVhdGVTY3JpcHRSZXN1bHQge1xuICAgIHJlc3VsdDogUmVtb3RlT2JqZWN0IHwgbnVsbDtcbiAgICBleGNlcHRpb25EZXRhaWxzOiBFeGNlcHRpb25EZXRhaWxzIHwgbnVsbDtcbiAgICBlcnJvcjogRXZhbHVhdGlvbkVycm9yIHwgbnVsbDtcbn1cblxuXG5jb25zdCBFWEVDVVRJT05fQ1RYX1dBU19ERVNUUk9ZRURfQ09ERSA9IC0zMjAwMDtcbmNvbnN0IFNFTEVDVE9SX01BWF9FWEVDVVRFX0NPVU5UICAgICAgID0gMTA7XG5jb25zdCBQUk9YWUxFU1NfU0NSSVBUICAgICAgICAgICAgICAgICA9ICd3aW5kb3dbXCIlcHJveHlsZXNzJVwiXSc7XG5cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQ2xpZW50RnVuY3Rpb25FeGVjdXRvciB7XG4gICAgLy8gbmV3IE1hcDxmcmFtZUlkLCBleGVjdXRpb25Db250ZXh0SWQ+XG4gICAgcHJpdmF0ZSByZWFkb25seSBfZnJhbWVFeGVjdXRpb25Db250ZXh0cyA9IG5ldyBNYXA8c3RyaW5nLCBudW1iZXI+KCk7XG4gICAgcHJpdmF0ZSBfY3VycmVudEZyYW1lSWQ6IHN0cmluZyA9ICcnO1xuXG4gICAgcHVibGljIGFzeW5jIGV2YWx1YXRlU2NyaXB0IChSdW50aW1lOiBSdW50aW1lQXBpLCBleHByZXNzaW9uOiBzdHJpbmcpOiBQcm9taXNlPEV2YWx1YXRlU2NyaXB0UmVzdWx0PiB7XG4gICAgICAgIGNvbnN0IHNjcmlwdDogRXZhbHVhdGVSZXF1ZXN0ID0geyBleHByZXNzaW9uLCBhd2FpdFByb21pc2U6IHRydWUgfTtcblxuICAgICAgICBpZiAodGhpcy5fY3VycmVudEZyYW1lSWQgJiYgdGhpcy5fZnJhbWVFeGVjdXRpb25Db250ZXh0cy5oYXModGhpcy5fY3VycmVudEZyYW1lSWQpKVxuICAgICAgICAgICAgc2NyaXB0LmNvbnRleHRJZCA9IHRoaXMuX2ZyYW1lRXhlY3V0aW9uQ29udGV4dHMuZ2V0KHRoaXMuX2N1cnJlbnRGcmFtZUlkKTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgeyByZXN1bHQsIGV4Y2VwdGlvbkRldGFpbHMgPSBudWxsIH0gPSBhd2FpdCBSdW50aW1lLmV2YWx1YXRlKHNjcmlwdCk7XG5cbiAgICAgICAgICAgIHJldHVybiB7IHJlc3VsdCwgZXhjZXB0aW9uRGV0YWlscywgZXJyb3I6IG51bGwgfTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHJldHVybiB7IHJlc3VsdDogbnVsbCwgZXhjZXB0aW9uRGV0YWlsczogbnVsbCwgZXJyb3IgfTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgX2V2YWx1YXRlU2NyaXB0V2l0aFJlbG9hZFBhZ2VJZ25vcmUgKFJ1bnRpbWU6IFJ1bnRpbWVBcGksIGV4cHJlc3Npb246IHN0cmluZyk6IFByb21pc2U8RXZhbHVhdGVTY3JpcHRSZXN1bHQ+IHtcbiAgICAgICAgbGV0IGF0dGVtcHRzID0gMDtcbiAgICAgICAgbGV0IHJlc3VsdDtcbiAgICAgICAgbGV0IGV4Y2VwdGlvbkRldGFpbHM7XG4gICAgICAgIGxldCBlcnJvcjtcblxuICAgICAgICB3aGlsZSAoYXR0ZW1wdHMrKyA8IFNFTEVDVE9SX01BWF9FWEVDVVRFX0NPVU5UKSB7XG4gICAgICAgICAgICAoeyByZXN1bHQsIGV4Y2VwdGlvbkRldGFpbHMsIGVycm9yIH0gPSBhd2FpdCB0aGlzLmV2YWx1YXRlU2NyaXB0KFJ1bnRpbWUsIGV4cHJlc3Npb24pKTtcblxuICAgICAgICAgICAgaWYgKGVycm9yICYmIGVycm9yLnJlc3BvbnNlLmNvZGUgPT09IEVYRUNVVElPTl9DVFhfV0FTX0RFU1RST1lFRF9DT0RFKVxuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuXG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tb2JqZWN0LWxpdGVyYWwtdHlwZS1hc3NlcnRpb25cbiAgICAgICAgcmV0dXJuIHsgcmVzdWx0LCBleGNlcHRpb25EZXRhaWxzLCBlcnJvciB9IGFzIEV2YWx1YXRlU2NyaXB0UmVzdWx0O1xuICAgIH1cblxuICAgIHByaXZhdGUgc3RhdGljIF9nZXRQcm9wZXJ0eUJ5TmFtZSAocHJvcGVydGllczogUHJvcGVydHlQcmV2aWV3W10sIG5hbWU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tbm9uLW51bGwtYXNzZXJ0aW9uXG4gICAgICAgIHJldHVybiBwcm9wZXJ0aWVzLmZpbmQocHJvcCA9PiBwcm9wLm5hbWUgPT09IG5hbWUpIS52YWx1ZSE7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgX3Rocm93RXhjZXB0aW9uIChkZXRhaWxzOiBFeGNlcHRpb25EZXRhaWxzLCBjb21tYW5kOiBFeGVjdXRlQ2xpZW50RnVuY3Rpb25Db21tYW5kQmFzZSwgY2FsbHNpdGU6IENhbGxzaXRlUmVjb3JkKTogbmV2ZXIge1xuICAgICAgICBjb25zdCBleGNlcHRpb24gPSBkZXRhaWxzLmV4Y2VwdGlvbjtcblxuICAgICAgICBpZiAoZXhjZXB0aW9uKSB7XG4gICAgICAgICAgICBjb25zdCBjbGFzc05hbWUgID0gZXhjZXB0aW9uLmNsYXNzTmFtZTtcbiAgICAgICAgICAgIGNvbnN0IHByb3BlcnRpZXMgPSBleGNlcHRpb24ucHJldmlldz8ucHJvcGVydGllcyBhcyBQcm9wZXJ0eVByZXZpZXdbXTtcblxuICAgICAgICAgICAgaWYgKGNsYXNzTmFtZSA9PT0gVW5jYXVnaHRFcnJvckluQ3VzdG9tRE9NUHJvcGVydHlDb2RlLm5hbWUpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgVW5jYXVnaHRFcnJvckluQ3VzdG9tRE9NUHJvcGVydHlDb2RlKGNvbW1hbmQuaW5zdGFudGlhdGlvbkNhbGxzaXRlTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgQ2xpZW50RnVuY3Rpb25FeGVjdXRvci5fZ2V0UHJvcGVydHlCeU5hbWUocHJvcGVydGllcywgJ2Vyck1zZycpLFxuICAgICAgICAgICAgICAgICAgICBDbGllbnRGdW5jdGlvbkV4ZWN1dG9yLl9nZXRQcm9wZXJ0eUJ5TmFtZShwcm9wZXJ0aWVzLCAncHJvcGVydHknKSxcbiAgICAgICAgICAgICAgICAgICAgY2FsbHNpdGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoY2xhc3NOYW1lID09PSBDYW5ub3RPYnRhaW5JbmZvRm9yRWxlbWVudFNwZWNpZmllZEJ5U2VsZWN0b3JFcnJvci5uYW1lKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IENhbm5vdE9idGFpbkluZm9Gb3JFbGVtZW50U3BlY2lmaWVkQnlTZWxlY3RvckVycm9yKGNhbGxzaXRlLCB7XG4gICAgICAgICAgICAgICAgICAgIGFwaUZuQ2hhaW46IGNvbW1hbmQuYXBpRm5DaGFpbixcbiAgICAgICAgICAgICAgICAgICAgYXBpRm5JbmRleDogcGFyc2VJbnQoQ2xpZW50RnVuY3Rpb25FeGVjdXRvci5fZ2V0UHJvcGVydHlCeU5hbWUocHJvcGVydGllcywgJ2FwaUZuSW5kZXgnKSwgMTApLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoY2xhc3NOYW1lID09PSBEb21Ob2RlQ2xpZW50RnVuY3Rpb25SZXN1bHRFcnJvci5uYW1lKVxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBEb21Ob2RlQ2xpZW50RnVuY3Rpb25SZXN1bHRFcnJvcihjb21tYW5kLmluc3RhbnRpYXRpb25DYWxsc2l0ZU5hbWUsIGNhbGxzaXRlKTtcbiAgICAgICAgICAgIGVsc2UgaWYgKGNsYXNzTmFtZSA9PT0gSW52YWxpZFNlbGVjdG9yUmVzdWx0RXJyb3IubmFtZSlcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgSW52YWxpZFNlbGVjdG9yUmVzdWx0RXJyb3IoY2FsbHNpdGUpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhyb3cgbmV3IFVuY2F1Z2h0RXJyb3JJbkNsaWVudEZ1bmN0aW9uQ29kZShjb21tYW5kLmluc3RhbnRpYXRpb25DYWxsc2l0ZU5hbWUsIGRldGFpbHMudGV4dCwgY2FsbHNpdGUpO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBleGVjdXRlQ2xpZW50RnVuY3Rpb24gKFJ1bnRpbWU6IFJ1bnRpbWVBcGksIGNvbW1hbmQ6IEV4ZWN1dGVDbGllbnRGdW5jdGlvbkNvbW1hbmQsIGNhbGxzaXRlOiBDYWxsc2l0ZVJlY29yZCk6IFByb21pc2U8b2JqZWN0PiB7XG4gICAgICAgIGNvbnN0IGV4cHJlc3Npb24gPSBgJHtQUk9YWUxFU1NfU0NSSVBUfS5leGVjdXRlQ2xpZW50RnVuY3Rpb25Db21tYW5kKCR7SlNPTi5zdHJpbmdpZnkoY29tbWFuZCl9KTtgO1xuXG4gICAgICAgIGNvbnN0IHsgcmVzdWx0LCBleGNlcHRpb25EZXRhaWxzLCBlcnJvciB9ID0gYXdhaXQgdGhpcy5ldmFsdWF0ZVNjcmlwdChSdW50aW1lLCBleHByZXNzaW9uKTtcblxuICAgICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgICAgIGlmIChlcnJvci5yZXNwb25zZS5jb2RlID09PSBFWEVDVVRJT05fQ1RYX1dBU19ERVNUUk9ZRURfQ09ERSlcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQ2xpZW50RnVuY3Rpb25FeGVjdXRpb25JbnRlcnJ1cHRpb25FcnJvcihjb21tYW5kLmluc3RhbnRpYXRpb25DYWxsc2l0ZU5hbWUsIGNhbGxzaXRlKTtcblxuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZXhjZXB0aW9uRGV0YWlscylcbiAgICAgICAgICAgIENsaWVudEZ1bmN0aW9uRXhlY3V0b3IuX3Rocm93RXhjZXB0aW9uKGV4Y2VwdGlvbkRldGFpbHMsIGNvbW1hbmQsIGNhbGxzaXRlKTtcblxuICAgICAgICByZXR1cm4gSlNPTi5wYXJzZShyZXN1bHQhLnZhbHVlKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tbm9uLW51bGwtYXNzZXJ0aW9uXG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGV4ZWN1dGVTZWxlY3RvciAoUnVudGltZTogUnVudGltZUFwaSwgY29tbWFuZDogRXhlY3V0ZVNlbGVjdG9yQ29tbWFuZCwgY2FsbHNpdGU6IENhbGxzaXRlUmVjb3JkLCBzZWxlY3RvclRpbWVvdXQ6IG51bWJlcik6IFByb21pc2U8b2JqZWN0PiB7XG4gICAgICAgIGNvbnN0IGV4cHJlc3Npb24gPSBgJHtQUk9YWUxFU1NfU0NSSVBUfS5leGVjdXRlU2VsZWN0b3JDb21tYW5kKCR7SlNPTi5zdHJpbmdpZnkoY29tbWFuZCl9LCAke3NlbGVjdG9yVGltZW91dH0sICR7RGF0ZS5ub3coKX0pO2A7XG5cbiAgICAgICAgY29uc3QgeyByZXN1bHQsIGV4Y2VwdGlvbkRldGFpbHMsIGVycm9yIH0gPSBhd2FpdCB0aGlzLl9ldmFsdWF0ZVNjcmlwdFdpdGhSZWxvYWRQYWdlSWdub3JlKFJ1bnRpbWUsIGV4cHJlc3Npb24pO1xuXG4gICAgICAgIGlmIChlcnJvcilcbiAgICAgICAgICAgIHRocm93IGVycm9yO1xuXG4gICAgICAgIGlmIChleGNlcHRpb25EZXRhaWxzKVxuICAgICAgICAgICAgQ2xpZW50RnVuY3Rpb25FeGVjdXRvci5fdGhyb3dFeGNlcHRpb24oZXhjZXB0aW9uRGV0YWlscywgY29tbWFuZCwgY2FsbHNpdGUpO1xuXG4gICAgICAgIHJldHVybiBKU09OLnBhcnNlKHJlc3VsdCEudmFsdWUpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1ub24tbnVsbC1hc3NlcnRpb25cbiAgICB9XG5cbiAgICBwdWJsaWMgc2V0dXBGcmFtZXNXYXRjaGluZyAoUnVudGltZTogUnVudGltZUFwaSk6IHZvaWQge1xuICAgICAgICBSdW50aW1lLm9uKCdleGVjdXRpb25Db250ZXh0Q3JlYXRlZCcsIChldmVudDogUHJvdG9jb2wuUnVudGltZS5FeGVjdXRpb25Db250ZXh0Q3JlYXRlZEV2ZW50KSA9PiB7XG4gICAgICAgICAgICBpZiAoIWV2ZW50LmNvbnRleHQuYXV4RGF0YT8uZnJhbWVJZClcbiAgICAgICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgICAgIHRoaXMuX2ZyYW1lRXhlY3V0aW9uQ29udGV4dHMuc2V0KGV2ZW50LmNvbnRleHQuYXV4RGF0YS5mcmFtZUlkLCBldmVudC5jb250ZXh0LmlkKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgUnVudGltZS5vbignZXhlY3V0aW9uQ29udGV4dERlc3Ryb3llZCcsIChldmVudDogUHJvdG9jb2wuUnVudGltZS5FeGVjdXRpb25Db250ZXh0RGVzdHJveWVkRXZlbnQpID0+IHtcbiAgICAgICAgICAgIGZvciAoY29uc3QgW2ZyYW1lSWQsIGV4ZWN1dGlvbkNvbnRleHRJZF0gb2YgdGhpcy5fZnJhbWVFeGVjdXRpb25Db250ZXh0cy5lbnRyaWVzKCkpIHtcbiAgICAgICAgICAgICAgICBpZiAoZXhlY3V0aW9uQ29udGV4dElkID09PSBldmVudC5leGVjdXRpb25Db250ZXh0SWQpXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2ZyYW1lRXhlY3V0aW9uQ29udGV4dHMuZGVsZXRlKGZyYW1lSWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBSdW50aW1lLm9uKCdleGVjdXRpb25Db250ZXh0c0NsZWFyZWQnLCAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLl9jdXJyZW50RnJhbWVJZCA9ICcnO1xuICAgICAgICAgICAgdGhpcy5fZnJhbWVFeGVjdXRpb25Db250ZXh0cy5jbGVhcigpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2V0Q3VycmVudEZyYW1lSWQgKGZyYW1lSWQ6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICB0aGlzLl9jdXJyZW50RnJhbWVJZCA9IGZyYW1lSWQ7XG4gICAgfVxufVxuIl19