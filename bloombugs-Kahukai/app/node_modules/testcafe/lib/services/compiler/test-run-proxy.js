"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const lodash_1 = require("lodash");
const test_run_tracker_1 = __importDefault(require("../../api/test-run-tracker"));
const test_controller_1 = __importDefault(require("../../api/test-controller"));
const observed_callsites_storage_1 = __importDefault(require("../../test-run/observed-callsites-storage"));
const warning_log_1 = __importDefault(require("../../notifications/warning-log"));
const type_1 = __importDefault(require("../../test-run/commands/type"));
const testcafe_hammerhead_1 = require("testcafe-hammerhead");
const re_executable_promise_1 = __importDefault(require("../../utils/re-executable-promise"));
const async_event_emitter_1 = __importDefault(require("../../utils/async-event-emitter"));
const marker_symbol_1 = __importDefault(require("../../test-run/marker-symbol"));
const constants_1 = require("../../test-run/execute-js-expression/constants");
const marker_1 = require("../serialization/replicator/transforms/function-marker-transform/marker");
const get_fn_1 = __importDefault(require("../../assertions/get-fn"));
const thennable_1 = require("../../utils/thennable");
const marker_2 = require("../serialization/replicator/transforms/promise-marker-transform/marker");
class TestRunProxy extends async_event_emitter_1.default {
    constructor({ dispatcher, id, test, options, browser, activeWindowId }) {
        super();
        this.debugging = false;
        this[marker_symbol_1.default] = true;
        this.dispatcher = dispatcher;
        this.id = id;
        this.test = test;
        this.ctx = Object.create(null);
        this.fixtureCtx = Object.create(null);
        this._options = options;
        this.browser = browser;
        this.assertionCommands = new Map();
        this.switchToWindowByPredicateCommands = new Map();
        this.asyncJsExpressionCallsites = new Map();
        this.controller = new test_controller_1.default(this);
        this.observedCallsites = new observed_callsites_storage_1.default();
        this.warningLog = new warning_log_1.default();
        this.disableMultipleWindows = options.disableMultipleWindows;
        this.activeWindowId = activeWindowId;
        test_run_tracker_1.default.addActiveTestRun(this);
        this._initializeRequestHooks();
    }
    _initializeRequestHooks() {
        this.test.requestHooks.forEach(this._attachWarningLog, this);
    }
    _attachWarningLog(hook) {
        hook._warningLog = this.warningLog;
    }
    _detachWarningLog(hook) {
        hook._warningLog = null;
    }
    _storeAssertionCommand(command) {
        command.id = testcafe_hammerhead_1.generateUniqueId();
        this.assertionCommands.set(command.id, command);
    }
    _storeSwitchToWindowByPredicateCommand(command) {
        command.id = testcafe_hammerhead_1.generateUniqueId();
        this.switchToWindowByPredicateCommands.set(command.id, command);
    }
    _handleAssertionCommand(command) {
        if (lodash_1.isFunction(command.actual)) {
            command.originActual = command.actual;
            command.actual = new marker_1.FunctionMarker();
            this._storeAssertionCommand(command);
        }
        else if (command.actual instanceof re_executable_promise_1.default)
            this._storeAssertionCommand(command);
        else if (thennable_1.isThennable(command.actual)) {
            command.originActual = command.actual;
            command.actual = new marker_2.PromiseMarker();
            this._storeAssertionCommand(command);
        }
    }
    _storeActionCallsitesForExecutedAsyncJsExpression(callsite) {
        // @ts-ignore
        if ((callsite === null || callsite === void 0 ? void 0 : callsite.filename) !== constants_1.ERROR_FILENAME)
            return;
        const id = testcafe_hammerhead_1.generateUniqueId();
        // @ts-ignore
        callsite.id = id;
        this.asyncJsExpressionCallsites.set(id, callsite);
    }
    async executeAction(apiMethodName, command, callsite) {
        this._storeActionCallsitesForExecutedAsyncJsExpression(callsite);
        if (command.type === type_1.default.assertion)
            this._handleAssertionCommand(command);
        else if (command.type === type_1.default.useRole)
            this.dispatcher.onRoleAppeared(command.role);
        else if (command.type === type_1.default.switchToWindowByPredicate)
            this._storeSwitchToWindowByPredicateCommand(command);
        return this.dispatcher.executeAction({
            apiMethodName,
            command,
            callsite,
            id: this.id,
        });
    }
    executeActionSync(apiMethodName, command, callsite) {
        if (command.type === type_1.default.assertion)
            this._handleAssertionCommand(command);
        else if (command.type === type_1.default.useRole)
            this.dispatcher.onRoleAppeared(command.role);
        return this.dispatcher.executeActionSync({
            apiMethodName,
            command,
            callsite,
            id: this.id,
        });
    }
    async executeCommand(command, callsite) {
        if (command.type === type_1.default.assertion)
            this._handleAssertionCommand(command);
        return this.dispatcher.executeCommand({
            command,
            callsite,
            id: this.id,
        });
    }
    async addRequestHook(hook) {
        if (this.test.requestHooks.includes(hook))
            return;
        this.test.requestHooks.push(hook);
        this._attachWarningLog(hook);
        await this.dispatcher.addRequestEventListeners({
            hookId: hook.id,
            hookClassName: hook._className,
            rules: hook._requestFilterRules,
        });
    }
    async removeRequestHook(hook) {
        if (!this.test.requestHooks.includes(hook))
            return;
        lodash_1.pull(this.test.requestHooks, hook);
        this._detachWarningLog(hook);
        await this.dispatcher.removeRequestEventListeners({ rules: hook._requestFilterRules });
    }
    async getAssertionActualValue(commandId) {
        const command = this.assertionCommands.get(commandId);
        return command.actual._reExecute();
    }
    async executeAssertionFn(commandId) {
        const command = this.assertionCommands.get(commandId);
        command.actual = command.originActual;
        const fn = get_fn_1.default(command);
        return await fn();
    }
    restoreOriginCallsiteForError(err) {
        err.errCallsite = this.asyncJsExpressionCallsites.get(err.errCallsite.id);
        this.asyncJsExpressionCallsites.clear();
    }
    checkWindow(commandId, { title, url }) {
        const command = this.switchToWindowByPredicateCommands.get(commandId);
        return command.checkWindow({ title, url });
    }
}
exports.default = TestRunProxy;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC1ydW4tcHJveHkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvc2VydmljZXMvY29tcGlsZXIvdGVzdC1ydW4tcHJveHkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxtQ0FBMEM7QUFDMUMsa0ZBQXdEO0FBRXhELGdGQUF1RDtBQUN2RCwyR0FBaUY7QUFDakYsa0ZBQXlEO0FBR3pELHdFQUF3RDtBQUt4RCw2REFBdUQ7QUFTdkQsOEZBQW9FO0FBQ3BFLDBGQUFnRTtBQUNoRSxpRkFBeUQ7QUFDekQsOEVBQWdGO0FBRWhGLG9HQUF5RztBQUN6RyxxRUFBNEM7QUFDNUMscURBQW9EO0FBQ3BELG1HQUF1RztBQUV2RyxNQUFNLFlBQWEsU0FBUSw2QkFBaUI7SUFtQnhDLFlBQW9CLEVBQUUsVUFBVSxFQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxjQUFjLEVBQW9CO1FBQzVGLEtBQUssRUFBRSxDQUFDO1FBWkwsY0FBUyxHQUFZLEtBQUssQ0FBQztRQWM5QixJQUFJLENBQUMsdUJBQWEsQ0FBQyxHQUFzQixJQUFJLENBQUM7UUFDOUMsSUFBSSxDQUFDLFVBQVUsR0FBMEIsVUFBVSxDQUFDO1FBQ3BELElBQUksQ0FBQyxFQUFFLEdBQWtDLEVBQUUsQ0FBQztRQUM1QyxJQUFJLENBQUMsSUFBSSxHQUFnQyxJQUFJLENBQUM7UUFDOUMsSUFBSSxDQUFDLEdBQUcsR0FBaUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM3RCxJQUFJLENBQUMsVUFBVSxHQUEwQixNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzdELElBQUksQ0FBQyxRQUFRLEdBQTRCLE9BQU8sQ0FBQztRQUNqRCxJQUFJLENBQUMsT0FBTyxHQUE2QixPQUFPLENBQUM7UUFDakQsSUFBSSxDQUFDLGlCQUFpQixHQUFtQixJQUFJLEdBQUcsRUFBNEIsQ0FBQztRQUM3RSxJQUFJLENBQUMsaUNBQWlDLEdBQUcsSUFBSSxHQUFHLEVBQTRDLENBQUM7UUFDN0YsSUFBSSxDQUFDLDBCQUEwQixHQUFVLElBQUksR0FBRyxFQUEwQixDQUFDO1FBQzNFLElBQUksQ0FBQyxVQUFVLEdBQTBCLElBQUkseUJBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNsRSxJQUFJLENBQUMsaUJBQWlCLEdBQW1CLElBQUksb0NBQXdCLEVBQUUsQ0FBQztRQUN4RSxJQUFJLENBQUMsVUFBVSxHQUEwQixJQUFJLHFCQUFVLEVBQUUsQ0FBQztRQUMxRCxJQUFJLENBQUMsc0JBQXNCLEdBQWMsT0FBTyxDQUFDLHNCQUFpQyxDQUFDO1FBQ25GLElBQUksQ0FBQyxjQUFjLEdBQXNCLGNBQWMsQ0FBQztRQUV4RCwwQkFBYyxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxDQUFDO1FBRXRDLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxDQUFDO0lBQ25DLENBQUM7SUFFTyx1QkFBdUI7UUFDM0IsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUNqRSxDQUFDO0lBRU8saUJBQWlCLENBQUUsSUFBaUI7UUFDeEMsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDO0lBQ3ZDLENBQUM7SUFFTyxpQkFBaUIsQ0FBRSxJQUFpQjtRQUN4QyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQztJQUM1QixDQUFDO0lBRU8sc0JBQXNCLENBQUUsT0FBeUI7UUFDckQsT0FBTyxDQUFDLEVBQUUsR0FBRyxzQ0FBZ0IsRUFBRSxDQUFDO1FBRWhDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEVBQUUsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUNwRCxDQUFDO0lBRU8sc0NBQXNDLENBQUUsT0FBeUM7UUFDckYsT0FBTyxDQUFDLEVBQUUsR0FBRyxzQ0FBZ0IsRUFBRSxDQUFDO1FBRWhDLElBQUksQ0FBQyxpQ0FBaUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEVBQUUsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUNwRSxDQUFDO0lBRU8sdUJBQXVCLENBQUUsT0FBeUI7UUFDdEQsSUFBSSxtQkFBVSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUM1QixPQUFPLENBQUMsWUFBWSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUM7WUFDdEMsT0FBTyxDQUFDLE1BQU0sR0FBUyxJQUFJLHVCQUFjLEVBQUUsQ0FBQztZQUU1QyxJQUFJLENBQUMsc0JBQXNCLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDeEM7YUFDSSxJQUFJLE9BQU8sQ0FBQyxNQUFNLFlBQVksK0JBQW1CO1lBQ2xELElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxPQUFPLENBQUMsQ0FBQzthQUVwQyxJQUFJLHVCQUFXLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQ2xDLE9BQU8sQ0FBQyxZQUFZLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQztZQUN0QyxPQUFPLENBQUMsTUFBTSxHQUFTLElBQUksc0JBQWEsRUFBRSxDQUFDO1lBRTNDLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUN4QztJQUNMLENBQUM7SUFFTyxpREFBaUQsQ0FBRSxRQUF3QjtRQUMvRSxhQUFhO1FBQ2IsSUFBSSxDQUFBLFFBQVEsYUFBUixRQUFRLHVCQUFSLFFBQVEsQ0FBRSxRQUFRLE1BQUssMEJBQWM7WUFDckMsT0FBTztRQUVYLE1BQU0sRUFBRSxHQUFHLHNDQUFnQixFQUFFLENBQUM7UUFFOUIsYUFBYTtRQUNiLFFBQVEsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDO1FBRWpCLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLFFBQTBCLENBQUMsQ0FBQztJQUN4RSxDQUFDO0lBRU0sS0FBSyxDQUFDLGFBQWEsQ0FBRSxhQUFxQixFQUFFLE9BQW9CLEVBQUUsUUFBd0I7UUFDN0YsSUFBSSxDQUFDLGlEQUFpRCxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBRWpFLElBQUksT0FBTyxDQUFDLElBQUksS0FBSyxjQUFZLENBQUMsU0FBUztZQUN2QyxJQUFJLENBQUMsdUJBQXVCLENBQUMsT0FBMkIsQ0FBQyxDQUFDO2FBQ3pELElBQUksT0FBTyxDQUFDLElBQUksS0FBSyxjQUFZLENBQUMsT0FBTztZQUMxQyxJQUFJLENBQUMsVUFBVSxDQUFDLGNBQWMsQ0FBRSxPQUEwQixDQUFDLElBQUksQ0FBQyxDQUFDO2FBQ2hFLElBQUksT0FBTyxDQUFDLElBQUksS0FBSyxjQUFZLENBQUMseUJBQXlCO1lBQzVELElBQUksQ0FBQyxzQ0FBc0MsQ0FBQyxPQUEyQyxDQUFDLENBQUM7UUFFN0YsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQztZQUNqQyxhQUFhO1lBQ2IsT0FBTztZQUNQLFFBQVE7WUFDUixFQUFFLEVBQUUsSUFBSSxDQUFDLEVBQUU7U0FDZCxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRU0saUJBQWlCLENBQUUsYUFBcUIsRUFBRSxPQUFvQixFQUFFLFFBQXdCO1FBQzNGLElBQUksT0FBTyxDQUFDLElBQUksS0FBSyxjQUFZLENBQUMsU0FBUztZQUN2QyxJQUFJLENBQUMsdUJBQXVCLENBQUMsT0FBMkIsQ0FBQyxDQUFDO2FBQ3pELElBQUksT0FBTyxDQUFDLElBQUksS0FBSyxjQUFZLENBQUMsT0FBTztZQUMxQyxJQUFJLENBQUMsVUFBVSxDQUFDLGNBQWMsQ0FBRSxPQUEwQixDQUFDLElBQUksQ0FBQyxDQUFDO1FBRXJFLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQztZQUNyQyxhQUFhO1lBQ2IsT0FBTztZQUNQLFFBQVE7WUFDUixFQUFFLEVBQUUsSUFBSSxDQUFDLEVBQUU7U0FDZCxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRU0sS0FBSyxDQUFDLGNBQWMsQ0FBRSxPQUFvQixFQUFFLFFBQWlCO1FBQ2hFLElBQUksT0FBTyxDQUFDLElBQUksS0FBSyxjQUFZLENBQUMsU0FBUztZQUN2QyxJQUFJLENBQUMsdUJBQXVCLENBQUMsT0FBMkIsQ0FBQyxDQUFDO1FBRTlELE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxjQUFjLENBQUM7WUFDbEMsT0FBTztZQUNQLFFBQVE7WUFDUixFQUFFLEVBQUUsSUFBSSxDQUFDLEVBQUU7U0FDZCxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRU0sS0FBSyxDQUFDLGNBQWMsQ0FBRSxJQUFpQjtRQUMxQyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUM7WUFDckMsT0FBTztRQUVYLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNsQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFN0IsTUFBTSxJQUFJLENBQUMsVUFBVSxDQUFDLHdCQUF3QixDQUFDO1lBQzNDLE1BQU0sRUFBUyxJQUFJLENBQUMsRUFBRTtZQUN0QixhQUFhLEVBQUUsSUFBSSxDQUFDLFVBQVU7WUFDOUIsS0FBSyxFQUFVLElBQUksQ0FBQyxtQkFBbUI7U0FDMUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVNLEtBQUssQ0FBQyxpQkFBaUIsQ0FBRSxJQUFpQjtRQUM3QyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQztZQUN0QyxPQUFPO1FBRVgsYUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ25DLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUU3QixNQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsMkJBQTJCLENBQUMsRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUMsQ0FBQztJQUMzRixDQUFDO0lBRU0sS0FBSyxDQUFDLHVCQUF1QixDQUFFLFNBQWlCO1FBQ25ELE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFxQixDQUFDO1FBRTFFLE9BQVEsT0FBTyxDQUFDLE1BQThCLENBQUMsVUFBVSxFQUFFLENBQUM7SUFDaEUsQ0FBQztJQUVNLEtBQUssQ0FBQyxrQkFBa0IsQ0FBRSxTQUFpQjtRQUM5QyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBcUIsQ0FBQztRQUUxRSxPQUFPLENBQUMsTUFBTSxHQUFHLE9BQU8sQ0FBQyxZQUFZLENBQUM7UUFFdEMsTUFBTSxFQUFFLEdBQUcsZ0JBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUUxQixPQUFPLE1BQU0sRUFBRSxFQUFFLENBQUM7SUFDdEIsQ0FBQztJQUVNLDZCQUE2QixDQUFFLEdBQXdDO1FBQzFFLEdBQUcsQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLDBCQUEwQixDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRTFFLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUM1QyxDQUFDO0lBRU0sV0FBVyxDQUFFLFNBQWlCLEVBQUUsRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUE0QjtRQUMzRSxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsaUNBQWlDLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBcUMsQ0FBQztRQUUxRyxPQUFPLE9BQU8sQ0FBQyxXQUFXLENBQUMsRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztJQUMvQyxDQUFDO0NBQ0o7QUFFRCxrQkFBZSxZQUFZLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBwdWxsLCBpc0Z1bmN0aW9uIH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB0ZXN0UnVuVHJhY2tlciBmcm9tICcuLi8uLi9hcGkvdGVzdC1ydW4tdHJhY2tlcic7XG5pbXBvcnQgeyBUZXN0UnVuRGlzcGF0Y2hlclByb3RvY29sIH0gZnJvbSAnLi9wcm90b2NvbCc7XG5pbXBvcnQgVGVzdENvbnRyb2xsZXIgZnJvbSAnLi4vLi4vYXBpL3Rlc3QtY29udHJvbGxlcic7XG5pbXBvcnQgT2JzZXJ2ZWRDYWxsc2l0ZXNTdG9yYWdlIGZyb20gJy4uLy4uL3Rlc3QtcnVuL29ic2VydmVkLWNhbGxzaXRlcy1zdG9yYWdlJztcbmltcG9ydCBXYXJuaW5nTG9nIGZyb20gJy4uLy4uL25vdGlmaWNhdGlvbnMvd2FybmluZy1sb2cnO1xuaW1wb3J0IEFzc2VydGlvbkNvbW1hbmQgZnJvbSAnLi4vLi4vdGVzdC1ydW4vY29tbWFuZHMvYXNzZXJ0aW9uJztcbmltcG9ydCB7IERpY3Rpb25hcnkgfSBmcm9tICcuLi8uLi9jb25maWd1cmF0aW9uL2ludGVyZmFjZXMnO1xuaW1wb3J0IENPTU1BTkRfVFlQRSBmcm9tICcuLi8uLi90ZXN0LXJ1bi9jb21tYW5kcy90eXBlJztcbmltcG9ydCBDb21tYW5kQmFzZSBmcm9tICcuLi8uLi90ZXN0LXJ1bi9jb21tYW5kcy9iYXNlJztcbmltcG9ydCB7IFRlc3RSdW5Qcm94eUluaXQgfSBmcm9tICcuLi9pbnRlcmZhY2VzJztcbmltcG9ydCBUZXN0IGZyb20gJy4uLy4uL2FwaS9zdHJ1Y3R1cmUvdGVzdCc7XG5pbXBvcnQgUmVxdWVzdEhvb2sgZnJvbSAnLi4vLi4vYXBpL3JlcXVlc3QtaG9va3MvaG9vayc7XG5pbXBvcnQgeyBnZW5lcmF0ZVVuaXF1ZUlkIH0gZnJvbSAndGVzdGNhZmUtaGFtbWVyaGVhZCc7XG5pbXBvcnQgeyBDYWxsc2l0ZVJlY29yZCB9IGZyb20gJ2NhbGxzaXRlLXJlY29yZCc7XG5cbmltcG9ydCB7XG4gICAgQ2hlY2tXaW5kb3dQcmVkaWNhdGVEYXRhLFxuICAgIFN3aXRjaFRvV2luZG93QnlQcmVkaWNhdGVDb21tYW5kLFxuICAgIFVzZVJvbGVDb21tYW5kLFxufSBmcm9tICcuLi8uLi90ZXN0LXJ1bi9jb21tYW5kcy9hY3Rpb25zJztcblxuaW1wb3J0IFJlRXhlY3V0YWJsZVByb21pc2UgZnJvbSAnLi4vLi4vdXRpbHMvcmUtZXhlY3V0YWJsZS1wcm9taXNlJztcbmltcG9ydCBBc3luY0V2ZW50RW1pdHRlciBmcm9tICcuLi8uLi91dGlscy9hc3luYy1ldmVudC1lbWl0dGVyJztcbmltcG9ydCB0ZXN0UnVuTWFya2VyIGZyb20gJy4uLy4uL3Rlc3QtcnVuL21hcmtlci1zeW1ib2wnO1xuaW1wb3J0IHsgRVJST1JfRklMRU5BTUUgfSBmcm9tICcuLi8uLi90ZXN0LXJ1bi9leGVjdXRlLWpzLWV4cHJlc3Npb24vY29uc3RhbnRzJztcbmltcG9ydCB7IFVuY2F1Z2h0VGVzdENhZmVFcnJvckluQ3VzdG9tU2NyaXB0IH0gZnJvbSAnLi4vLi4vZXJyb3JzL3Rlc3QtcnVuJztcbmltcG9ydCB7IEZ1bmN0aW9uTWFya2VyIH0gZnJvbSAnLi4vc2VyaWFsaXphdGlvbi9yZXBsaWNhdG9yL3RyYW5zZm9ybXMvZnVuY3Rpb24tbWFya2VyLXRyYW5zZm9ybS9tYXJrZXInO1xuaW1wb3J0IGdldEZuIGZyb20gJy4uLy4uL2Fzc2VydGlvbnMvZ2V0LWZuJztcbmltcG9ydCB7IGlzVGhlbm5hYmxlIH0gZnJvbSAnLi4vLi4vdXRpbHMvdGhlbm5hYmxlJztcbmltcG9ydCB7IFByb21pc2VNYXJrZXIgfSBmcm9tICcuLi9zZXJpYWxpemF0aW9uL3JlcGxpY2F0b3IvdHJhbnNmb3Jtcy9wcm9taXNlLW1hcmtlci10cmFuc2Zvcm0vbWFya2VyJztcblxuY2xhc3MgVGVzdFJ1blByb3h5IGV4dGVuZHMgQXN5bmNFdmVudEVtaXR0ZXIge1xuICAgIHByaXZhdGUgW3Rlc3RSdW5NYXJrZXJdOiBib29sZWFuO1xuICAgIHB1YmxpYyByZWFkb25seSBpZDogc3RyaW5nO1xuICAgIHB1YmxpYyByZWFkb25seSB0ZXN0OiBUZXN0O1xuICAgIHB1YmxpYyByZWFkb25seSBjb250cm9sbGVyOiBUZXN0Q29udHJvbGxlcjtcbiAgICBwdWJsaWMgcmVhZG9ubHkgb2JzZXJ2ZWRDYWxsc2l0ZXM6IE9ic2VydmVkQ2FsbHNpdGVzU3RvcmFnZTtcbiAgICBwdWJsaWMgcmVhZG9ubHkgd2FybmluZ0xvZzogV2FybmluZ0xvZztcbiAgICBwdWJsaWMgZml4dHVyZUN0eDogb2JqZWN0O1xuICAgIHB1YmxpYyBkZWJ1Z2dpbmc6IGJvb2xlYW4gPSBmYWxzZTtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGRpc3BhdGNoZXI6IFRlc3RSdW5EaXNwYXRjaGVyUHJvdG9jb2w7XG4gICAgcHVibGljIGN0eDogb2JqZWN0O1xuICAgIHByaXZhdGUgcmVhZG9ubHkgX29wdGlvbnM6IERpY3Rpb25hcnk8T3B0aW9uVmFsdWU+O1xuICAgIHByaXZhdGUgcmVhZG9ubHkgYXNzZXJ0aW9uQ29tbWFuZHM6IE1hcDxzdHJpbmcsIEFzc2VydGlvbkNvbW1hbmQ+O1xuICAgIHByaXZhdGUgcmVhZG9ubHkgc3dpdGNoVG9XaW5kb3dCeVByZWRpY2F0ZUNvbW1hbmRzOiBNYXA8c3RyaW5nLCBTd2l0Y2hUb1dpbmRvd0J5UHJlZGljYXRlQ29tbWFuZD47XG4gICAgcHJpdmF0ZSByZWFkb25seSBhc3luY0pzRXhwcmVzc2lvbkNhbGxzaXRlczogTWFwPHN0cmluZywgQ2FsbHNpdGVSZWNvcmQ+O1xuICAgIHB1YmxpYyByZWFkb25seSBicm93c2VyOiBCcm93c2VyO1xuICAgIHB1YmxpYyByZWFkb25seSBkaXNhYmxlTXVsdGlwbGVXaW5kb3dzOiBib29sZWFuO1xuICAgIHB1YmxpYyBhY3RpdmVXaW5kb3dJZDogbnVsbCB8IHN0cmluZztcblxuICAgIHB1YmxpYyBjb25zdHJ1Y3RvciAoeyBkaXNwYXRjaGVyLCBpZCwgdGVzdCwgb3B0aW9ucywgYnJvd3NlciwgYWN0aXZlV2luZG93SWQgfTogVGVzdFJ1blByb3h5SW5pdCkge1xuICAgICAgICBzdXBlcigpO1xuXG4gICAgICAgIHRoaXNbdGVzdFJ1bk1hcmtlcl0gICAgICAgICAgICAgICAgICAgID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5kaXNwYXRjaGVyICAgICAgICAgICAgICAgICAgICAgICAgPSBkaXNwYXRjaGVyO1xuICAgICAgICB0aGlzLmlkICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA9IGlkO1xuICAgICAgICB0aGlzLnRlc3QgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA9IHRlc3Q7XG4gICAgICAgIHRoaXMuY3R4ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID0gT2JqZWN0LmNyZWF0ZShudWxsKTtcbiAgICAgICAgdGhpcy5maXh0dXJlQ3R4ICAgICAgICAgICAgICAgICAgICAgICAgPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuICAgICAgICB0aGlzLl9vcHRpb25zICAgICAgICAgICAgICAgICAgICAgICAgICA9IG9wdGlvbnM7XG4gICAgICAgIHRoaXMuYnJvd3NlciAgICAgICAgICAgICAgICAgICAgICAgICAgID0gYnJvd3NlcjtcbiAgICAgICAgdGhpcy5hc3NlcnRpb25Db21tYW5kcyAgICAgICAgICAgICAgICAgPSBuZXcgTWFwPHN0cmluZywgQXNzZXJ0aW9uQ29tbWFuZD4oKTtcbiAgICAgICAgdGhpcy5zd2l0Y2hUb1dpbmRvd0J5UHJlZGljYXRlQ29tbWFuZHMgPSBuZXcgTWFwPHN0cmluZywgU3dpdGNoVG9XaW5kb3dCeVByZWRpY2F0ZUNvbW1hbmQ+KCk7XG4gICAgICAgIHRoaXMuYXN5bmNKc0V4cHJlc3Npb25DYWxsc2l0ZXMgICAgICAgID0gbmV3IE1hcDxzdHJpbmcsIENhbGxzaXRlUmVjb3JkPigpO1xuICAgICAgICB0aGlzLmNvbnRyb2xsZXIgICAgICAgICAgICAgICAgICAgICAgICA9IG5ldyBUZXN0Q29udHJvbGxlcih0aGlzKTtcbiAgICAgICAgdGhpcy5vYnNlcnZlZENhbGxzaXRlcyAgICAgICAgICAgICAgICAgPSBuZXcgT2JzZXJ2ZWRDYWxsc2l0ZXNTdG9yYWdlKCk7XG4gICAgICAgIHRoaXMud2FybmluZ0xvZyAgICAgICAgICAgICAgICAgICAgICAgID0gbmV3IFdhcm5pbmdMb2coKTtcbiAgICAgICAgdGhpcy5kaXNhYmxlTXVsdGlwbGVXaW5kb3dzICAgICAgICAgICAgPSBvcHRpb25zLmRpc2FibGVNdWx0aXBsZVdpbmRvd3MgYXMgYm9vbGVhbjtcbiAgICAgICAgdGhpcy5hY3RpdmVXaW5kb3dJZCAgICAgICAgICAgICAgICAgICAgPSBhY3RpdmVXaW5kb3dJZDtcblxuICAgICAgICB0ZXN0UnVuVHJhY2tlci5hZGRBY3RpdmVUZXN0UnVuKHRoaXMpO1xuXG4gICAgICAgIHRoaXMuX2luaXRpYWxpemVSZXF1ZXN0SG9va3MoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9pbml0aWFsaXplUmVxdWVzdEhvb2tzICgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy50ZXN0LnJlcXVlc3RIb29rcy5mb3JFYWNoKHRoaXMuX2F0dGFjaFdhcm5pbmdMb2csIHRoaXMpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2F0dGFjaFdhcm5pbmdMb2cgKGhvb2s6IFJlcXVlc3RIb29rKTogdm9pZCB7XG4gICAgICAgIGhvb2suX3dhcm5pbmdMb2cgPSB0aGlzLndhcm5pbmdMb2c7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZGV0YWNoV2FybmluZ0xvZyAoaG9vazogUmVxdWVzdEhvb2spOiB2b2lkIHtcbiAgICAgICAgaG9vay5fd2FybmluZ0xvZyA9IG51bGw7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfc3RvcmVBc3NlcnRpb25Db21tYW5kIChjb21tYW5kOiBBc3NlcnRpb25Db21tYW5kKTogdm9pZCB7XG4gICAgICAgIGNvbW1hbmQuaWQgPSBnZW5lcmF0ZVVuaXF1ZUlkKCk7XG5cbiAgICAgICAgdGhpcy5hc3NlcnRpb25Db21tYW5kcy5zZXQoY29tbWFuZC5pZCwgY29tbWFuZCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfc3RvcmVTd2l0Y2hUb1dpbmRvd0J5UHJlZGljYXRlQ29tbWFuZCAoY29tbWFuZDogU3dpdGNoVG9XaW5kb3dCeVByZWRpY2F0ZUNvbW1hbmQpOiB2b2lkIHtcbiAgICAgICAgY29tbWFuZC5pZCA9IGdlbmVyYXRlVW5pcXVlSWQoKTtcblxuICAgICAgICB0aGlzLnN3aXRjaFRvV2luZG93QnlQcmVkaWNhdGVDb21tYW5kcy5zZXQoY29tbWFuZC5pZCwgY29tbWFuZCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfaGFuZGxlQXNzZXJ0aW9uQ29tbWFuZCAoY29tbWFuZDogQXNzZXJ0aW9uQ29tbWFuZCk6IHZvaWQge1xuICAgICAgICBpZiAoaXNGdW5jdGlvbihjb21tYW5kLmFjdHVhbCkpIHtcbiAgICAgICAgICAgIGNvbW1hbmQub3JpZ2luQWN0dWFsID0gY29tbWFuZC5hY3R1YWw7XG4gICAgICAgICAgICBjb21tYW5kLmFjdHVhbCAgICAgICA9IG5ldyBGdW5jdGlvbk1hcmtlcigpO1xuXG4gICAgICAgICAgICB0aGlzLl9zdG9yZUFzc2VydGlvbkNvbW1hbmQoY29tbWFuZCk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAoY29tbWFuZC5hY3R1YWwgaW5zdGFuY2VvZiBSZUV4ZWN1dGFibGVQcm9taXNlKVxuICAgICAgICAgICAgdGhpcy5fc3RvcmVBc3NlcnRpb25Db21tYW5kKGNvbW1hbmQpO1xuXG4gICAgICAgIGVsc2UgaWYgKGlzVGhlbm5hYmxlKGNvbW1hbmQuYWN0dWFsKSkge1xuICAgICAgICAgICAgY29tbWFuZC5vcmlnaW5BY3R1YWwgPSBjb21tYW5kLmFjdHVhbDtcbiAgICAgICAgICAgIGNvbW1hbmQuYWN0dWFsICAgICAgID0gbmV3IFByb21pc2VNYXJrZXIoKTtcblxuICAgICAgICAgICAgdGhpcy5fc3RvcmVBc3NlcnRpb25Db21tYW5kKGNvbW1hbmQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfc3RvcmVBY3Rpb25DYWxsc2l0ZXNGb3JFeGVjdXRlZEFzeW5jSnNFeHByZXNzaW9uIChjYWxsc2l0ZTogQ2FsbHNpdGVSZWNvcmQpOiB2b2lkIHtcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICBpZiAoY2FsbHNpdGU/LmZpbGVuYW1lICE9PSBFUlJPUl9GSUxFTkFNRSlcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICBjb25zdCBpZCA9IGdlbmVyYXRlVW5pcXVlSWQoKTtcblxuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIGNhbGxzaXRlLmlkID0gaWQ7XG5cbiAgICAgICAgdGhpcy5hc3luY0pzRXhwcmVzc2lvbkNhbGxzaXRlcy5zZXQoaWQsIGNhbGxzaXRlIGFzIENhbGxzaXRlUmVjb3JkKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgZXhlY3V0ZUFjdGlvbiAoYXBpTWV0aG9kTmFtZTogc3RyaW5nLCBjb21tYW5kOiBDb21tYW5kQmFzZSwgY2FsbHNpdGU6IENhbGxzaXRlUmVjb3JkKTogUHJvbWlzZTx1bmtub3duPiB7XG4gICAgICAgIHRoaXMuX3N0b3JlQWN0aW9uQ2FsbHNpdGVzRm9yRXhlY3V0ZWRBc3luY0pzRXhwcmVzc2lvbihjYWxsc2l0ZSk7XG5cbiAgICAgICAgaWYgKGNvbW1hbmQudHlwZSA9PT0gQ09NTUFORF9UWVBFLmFzc2VydGlvbilcbiAgICAgICAgICAgIHRoaXMuX2hhbmRsZUFzc2VydGlvbkNvbW1hbmQoY29tbWFuZCBhcyBBc3NlcnRpb25Db21tYW5kKTtcbiAgICAgICAgZWxzZSBpZiAoY29tbWFuZC50eXBlID09PSBDT01NQU5EX1RZUEUudXNlUm9sZSlcbiAgICAgICAgICAgIHRoaXMuZGlzcGF0Y2hlci5vblJvbGVBcHBlYXJlZCgoY29tbWFuZCBhcyBVc2VSb2xlQ29tbWFuZCkucm9sZSk7XG4gICAgICAgIGVsc2UgaWYgKGNvbW1hbmQudHlwZSA9PT0gQ09NTUFORF9UWVBFLnN3aXRjaFRvV2luZG93QnlQcmVkaWNhdGUpXG4gICAgICAgICAgICB0aGlzLl9zdG9yZVN3aXRjaFRvV2luZG93QnlQcmVkaWNhdGVDb21tYW5kKGNvbW1hbmQgYXMgU3dpdGNoVG9XaW5kb3dCeVByZWRpY2F0ZUNvbW1hbmQpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLmRpc3BhdGNoZXIuZXhlY3V0ZUFjdGlvbih7XG4gICAgICAgICAgICBhcGlNZXRob2ROYW1lLFxuICAgICAgICAgICAgY29tbWFuZCxcbiAgICAgICAgICAgIGNhbGxzaXRlLFxuICAgICAgICAgICAgaWQ6IHRoaXMuaWQsXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBleGVjdXRlQWN0aW9uU3luYyAoYXBpTWV0aG9kTmFtZTogc3RyaW5nLCBjb21tYW5kOiBDb21tYW5kQmFzZSwgY2FsbHNpdGU6IENhbGxzaXRlUmVjb3JkKTogdW5rbm93biB7XG4gICAgICAgIGlmIChjb21tYW5kLnR5cGUgPT09IENPTU1BTkRfVFlQRS5hc3NlcnRpb24pXG4gICAgICAgICAgICB0aGlzLl9oYW5kbGVBc3NlcnRpb25Db21tYW5kKGNvbW1hbmQgYXMgQXNzZXJ0aW9uQ29tbWFuZCk7XG4gICAgICAgIGVsc2UgaWYgKGNvbW1hbmQudHlwZSA9PT0gQ09NTUFORF9UWVBFLnVzZVJvbGUpXG4gICAgICAgICAgICB0aGlzLmRpc3BhdGNoZXIub25Sb2xlQXBwZWFyZWQoKGNvbW1hbmQgYXMgVXNlUm9sZUNvbW1hbmQpLnJvbGUpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLmRpc3BhdGNoZXIuZXhlY3V0ZUFjdGlvblN5bmMoe1xuICAgICAgICAgICAgYXBpTWV0aG9kTmFtZSxcbiAgICAgICAgICAgIGNvbW1hbmQsXG4gICAgICAgICAgICBjYWxsc2l0ZSxcbiAgICAgICAgICAgIGlkOiB0aGlzLmlkLFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgZXhlY3V0ZUNvbW1hbmQgKGNvbW1hbmQ6IENvbW1hbmRCYXNlLCBjYWxsc2l0ZT86IHN0cmluZyk6IFByb21pc2U8dW5rbm93bj4ge1xuICAgICAgICBpZiAoY29tbWFuZC50eXBlID09PSBDT01NQU5EX1RZUEUuYXNzZXJ0aW9uKVxuICAgICAgICAgICAgdGhpcy5faGFuZGxlQXNzZXJ0aW9uQ29tbWFuZChjb21tYW5kIGFzIEFzc2VydGlvbkNvbW1hbmQpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLmRpc3BhdGNoZXIuZXhlY3V0ZUNvbW1hbmQoe1xuICAgICAgICAgICAgY29tbWFuZCxcbiAgICAgICAgICAgIGNhbGxzaXRlLFxuICAgICAgICAgICAgaWQ6IHRoaXMuaWQsXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBhZGRSZXF1ZXN0SG9vayAoaG9vazogUmVxdWVzdEhvb2spOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgaWYgKHRoaXMudGVzdC5yZXF1ZXN0SG9va3MuaW5jbHVkZXMoaG9vaykpXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgdGhpcy50ZXN0LnJlcXVlc3RIb29rcy5wdXNoKGhvb2spO1xuICAgICAgICB0aGlzLl9hdHRhY2hXYXJuaW5nTG9nKGhvb2spO1xuXG4gICAgICAgIGF3YWl0IHRoaXMuZGlzcGF0Y2hlci5hZGRSZXF1ZXN0RXZlbnRMaXN0ZW5lcnMoe1xuICAgICAgICAgICAgaG9va0lkOiAgICAgICAgaG9vay5pZCxcbiAgICAgICAgICAgIGhvb2tDbGFzc05hbWU6IGhvb2suX2NsYXNzTmFtZSxcbiAgICAgICAgICAgIHJ1bGVzOiAgICAgICAgIGhvb2suX3JlcXVlc3RGaWx0ZXJSdWxlcyxcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIHJlbW92ZVJlcXVlc3RIb29rIChob29rOiBSZXF1ZXN0SG9vayk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBpZiAoIXRoaXMudGVzdC5yZXF1ZXN0SG9va3MuaW5jbHVkZXMoaG9vaykpXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgcHVsbCh0aGlzLnRlc3QucmVxdWVzdEhvb2tzLCBob29rKTtcbiAgICAgICAgdGhpcy5fZGV0YWNoV2FybmluZ0xvZyhob29rKTtcblxuICAgICAgICBhd2FpdCB0aGlzLmRpc3BhdGNoZXIucmVtb3ZlUmVxdWVzdEV2ZW50TGlzdGVuZXJzKHsgcnVsZXM6IGhvb2suX3JlcXVlc3RGaWx0ZXJSdWxlcyB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgZ2V0QXNzZXJ0aW9uQWN0dWFsVmFsdWUgKGNvbW1hbmRJZDogc3RyaW5nKTogUHJvbWlzZTx1bmtub3duPiB7XG4gICAgICAgIGNvbnN0IGNvbW1hbmQgPSB0aGlzLmFzc2VydGlvbkNvbW1hbmRzLmdldChjb21tYW5kSWQpIGFzIEFzc2VydGlvbkNvbW1hbmQ7XG5cbiAgICAgICAgcmV0dXJuIChjb21tYW5kLmFjdHVhbCBhcyBSZUV4ZWN1dGFibGVQcm9taXNlKS5fcmVFeGVjdXRlKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGV4ZWN1dGVBc3NlcnRpb25GbiAoY29tbWFuZElkOiBzdHJpbmcpOiBQcm9taXNlPHVua25vd24+IHtcbiAgICAgICAgY29uc3QgY29tbWFuZCA9IHRoaXMuYXNzZXJ0aW9uQ29tbWFuZHMuZ2V0KGNvbW1hbmRJZCkgYXMgQXNzZXJ0aW9uQ29tbWFuZDtcblxuICAgICAgICBjb21tYW5kLmFjdHVhbCA9IGNvbW1hbmQub3JpZ2luQWN0dWFsO1xuXG4gICAgICAgIGNvbnN0IGZuID0gZ2V0Rm4oY29tbWFuZCk7XG5cbiAgICAgICAgcmV0dXJuIGF3YWl0IGZuKCk7XG4gICAgfVxuXG4gICAgcHVibGljIHJlc3RvcmVPcmlnaW5DYWxsc2l0ZUZvckVycm9yIChlcnI6IFVuY2F1Z2h0VGVzdENhZmVFcnJvckluQ3VzdG9tU2NyaXB0KTogdm9pZCB7XG4gICAgICAgIGVyci5lcnJDYWxsc2l0ZSA9IHRoaXMuYXN5bmNKc0V4cHJlc3Npb25DYWxsc2l0ZXMuZ2V0KGVyci5lcnJDYWxsc2l0ZS5pZCk7XG5cbiAgICAgICAgdGhpcy5hc3luY0pzRXhwcmVzc2lvbkNhbGxzaXRlcy5jbGVhcigpO1xuICAgIH1cblxuICAgIHB1YmxpYyBjaGVja1dpbmRvdyAoY29tbWFuZElkOiBzdHJpbmcsIHsgdGl0bGUsIHVybCB9OiBDaGVja1dpbmRvd1ByZWRpY2F0ZURhdGEpOiBib29sZWFuIHtcbiAgICAgICAgY29uc3QgY29tbWFuZCA9IHRoaXMuc3dpdGNoVG9XaW5kb3dCeVByZWRpY2F0ZUNvbW1hbmRzLmdldChjb21tYW5kSWQpIGFzIFN3aXRjaFRvV2luZG93QnlQcmVkaWNhdGVDb21tYW5kO1xuXG4gICAgICAgIHJldHVybiBjb21tYW5kLmNoZWNrV2luZG93KHsgdGl0bGUsIHVybCB9KTtcbiAgICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFRlc3RSdW5Qcm94eTtcblxuXG4iXX0=